import{r as o,f as K,j as t,br as se,bs as ne,bt as Y,bu as G,bv as $}from"./vendor-Cw4NQglw.js";import{z as oe}from"./index-CvVW4uF4.js";import"./ui-BQCqNqg0.js";import"./mapbox-ChopjHYq.js";const re="pk.eyJ1Ijoic2Fya2Nlc3NjcmV3IiwiYSI6ImNta3h2bW1qcjAwczYzZnM2bHVpYno0Y2MifQ.nRcFWDvtPkocjBHhltSm3w";function ae(i,g,U,l){const k=i*Math.PI/180,u=g*Math.PI/180,f=U*Math.PI/180,M=l*Math.PI/180,w=Math.sin(M-u)*Math.cos(f),c=Math.cos(k)*Math.sin(f)-Math.sin(k)*Math.cos(f)*Math.cos(M-u);return(Math.atan2(w,c)*180/Math.PI+360)%360}function me({scheduleId:i}){const g=o.useRef(null),{theme:U}=oe(),[l,k]=o.useState(null),[u,f]=o.useState(null),[M,w]=o.useState(0),[c,y]=o.useState([]),[I,h]=o.useState([]),C=o.useRef(null),[P,z]=o.useState(!1),V=o.useRef(null),L=o.useRef(null),S=o.useRef(0);o.useEffect(()=>{u&&(L.current=u)},[u]),o.useEffect(()=>{console.log("[LiveMap] Schedule changed to:",i,"- resetting state"),k(null),f(null),w(0),y([]),h([]),C.current=null,L.current=null,S.current=0},[i]),o.useEffect(()=>{const e=[300,600,1e3].map(s=>setTimeout(()=>g.current?.resize(),s));return()=>e.forEach(clearTimeout)},[]);const R=o.useCallback(e=>{g.current&&g.current.flyTo({center:e,duration:1e3})},[]),{data:a}=K({queryKey:[`/api/schedules/${i}`],queryFn:async()=>{const e=await fetch(`/api/schedules/${i}`);if(!e.ok)throw new Error("Failed to fetch schedule");return e.json()}});o.useEffect(()=>{if(a){if(a.route?.geometry&&a.route.geometry.length>1){console.log("[LiveMap] Setting road path from schedule geometry:",a.route.geometry.length,"points"),y(a.route.geometry);const e=a.route.geometry[a.route.geometry.length-1];f(e)}else if(a.route?.coordinates?.end)console.log("[LiveMap] Setting destination from schedule coordinates"),f([a.route.coordinates.end.lng,a.route.coordinates.end.lat]);else if(a.endLocation||a.route?.endLocation){const e=a.endLocation||a.route?.endLocation;fetch(`/api/bus-stops/search?q=${encodeURIComponent(e)}`).then(s=>s.json()).then(s=>{s.length>0&&s[0].location&&f([s[0].location.lng,s[0].location.lat])}).catch(s=>console.error("Destination lookup failed:",s))}}},[a]);const j=a?.routeId,{data:d}=K({queryKey:[`/api/routes/${j}`],queryFn:async()=>{if(!j)return null;const e=await fetch(`/api/routes/${j}`);if(!e.ok)throw new Error("Failed to fetch route");return e.json()},enabled:!!j});o.useEffect(()=>{if(!(!d||c.length>1)){if(d.geometry&&d.geometry.length>1)console.log("[LiveMap] Setting road path from route geometry"),y(d.geometry),u||f(d.geometry[d.geometry.length-1]);else if(d.stops&&d.stops.length>=2){const e=d.stops.filter(s=>s.location?.lat&&s.location?.lng);if(e.length>=2){const s=e.map(n=>[n.location.lng,n.location.lat]);fetch("/api/directions",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({coordinates:s})}).then(n=>n.json()).then(n=>{n?.geometry&&(y(n.geometry),u||f(n.geometry[n.geometry.length-1]))}).catch(n=>console.error("Directions lookup failed:",n))}}}},[d,c.length,u]);const F=(e,s)=>Math.pow(e[0]-s[0],2)+Math.pow(e[1]-s[1],2),H=(e,s,n)=>{const m=e[0],p=e[1],r=s[0],b=s[1],T=n[0],N=n[1],O=m-r,q=p-b,x=T-r,v=N-b,te=O*x+q*v,W=x*x+v*v;let D=-1;W!==0&&(D=te/W);let B,A;return D<0?(B=r,A=b):D>1?(B=T,A=N):(B=r+D*x,A=b+D*v),[B,A]},J=o.useCallback(async e=>{const s=L.current;if(s&&!(Date.now()-S.current<1e4)){S.current=Date.now(),console.log("[LiveMap] Off-route detected! Calculating new route from current position to destination only...");try{const m=await(await fetch("/api/directions",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({coordinates:[e,s]})})).json();m?.geometry&&m.geometry.length>1&&(console.log("[LiveMap] New route calculated:",m.geometry.length,"points to destination"),y(m.geometry),h([e,...m.geometry.slice(1)]))}catch(n){console.error("[LiveMap] Reroute failed:",n),h([e,s])}}},[]),E=o.useCallback(e=>{const s=L.current;if(!s){h([]);return}if(c.length>1){let n=1/0,m=0,p=e;for(let N=0;N<c.length-1;N++){const O=c[N],q=c[N+1],x=H(e,O,q),v=F(e,x);v<n&&(n=v,m=N,p=x)}if(n>4e-7){J(e),h([e,s]);return}const r=c.slice(m+1),b=r.length>0?r[r.length-1]:p;F(b,s)>1e-6?h([e,p,...r,s]):h([e,p,...r]);return}h([e,s])},[c,J]);o.useEffect(()=>{l&&E(l)},[l,c,E]),o.useEffect(()=>{const s=`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}/ws/tracking`,n=new WebSocket(s);return n.onopen=()=>{z(!0),n.send(JSON.stringify({type:"TRACKING_SUBSCRIBE",scheduleId:i}))},n.onmessage=m=>{const p=JSON.parse(m.data);if(p.type==="BUS_LOCATION"&&p.scheduleId===i){const r=[p.location.lng,p.location.lat];if(C.current){const b=ae(C.current[1],C.current[0],r[1],r[0]);w(b)}C.current=r,k(r),R(r),E(r)}},n.onclose=()=>z(!1),V.current=n,()=>{V.current&&V.current.close()}},[i,R,E]);const _={type:"Feature",properties:{},geometry:{type:"LineString",coordinates:c}},Q={type:"Feature",properties:{},geometry:{type:"LineString",coordinates:I}},X={id:`planned-route-${i}`,type:"line",paint:{"line-color":"#94a3b8","line-width":5,"line-opacity":.4,"line-dasharray":[2,2]},layout:{"line-cap":"round","line-join":"round"}},Z={id:`remaining-route-${i}`,type:"line",paint:{"line-color":"#fbbf24","line-width":6,"line-opacity":.9},layout:{"line-cap":"round","line-join":"round"}};if(!l)return t.jsxDEV("div",{className:"flex flex-col items-center justify-center p-8 bg-slate-50 dark:bg-slate-900 rounded-2xl border-2 border-dashed border-slate-200 dark:border-slate-800 transition-colors min-h-[300px]",children:[t.jsxDEV("div",{className:"w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-4"},void 0,!1,{fileName:"C:/Users/sarkc/Desktop/Ayanda/Bus-Connect/client/src/components/LiveMap.tsx",lineNumber:387,columnNumber:17},this),t.jsxDEV("p",{className:"text-slate-500 dark:text-slate-400 font-medium",children:"Waiting for driver to start tracking..."},void 0,!1,{fileName:"C:/Users/sarkc/Desktop/Ayanda/Bus-Connect/client/src/components/LiveMap.tsx",lineNumber:388,columnNumber:17},this),t.jsxDEV("p",{className:"text-xs text-slate-400 dark:text-slate-500 mt-1",children:"Refreshes automatically when location is available"},void 0,!1,{fileName:"C:/Users/sarkc/Desktop/Ayanda/Bus-Connect/client/src/components/LiveMap.tsx",lineNumber:389,columnNumber:17},this)]},void 0,!0,{fileName:"C:/Users/sarkc/Desktop/Ayanda/Bus-Connect/client/src/components/LiveMap.tsx",lineNumber:386,columnNumber:13},this);const ee=U==="dark"?"mapbox://styles/mapbox/dark-v11":"mapbox://styles/mapbox/streets-v12";return t.jsxDEV("div",{className:"h-[400px] w-full rounded-2xl overflow-hidden border border-slate-200 dark:border-slate-800 shadow-inner relative transition-colors",children:[t.jsxDEV(se,{ref:g,initialViewState:{longitude:l[0],latitude:l[1],zoom:15},style:{width:"100%",height:"100%"},mapStyle:ee,mapboxAccessToken:re,children:[t.jsxDEV(ne,{position:"top-right"},void 0,!1,{fileName:"C:/Users/sarkc/Desktop/Ayanda/Bus-Connect/client/src/components/LiveMap.tsx",lineNumber:411,columnNumber:17},this),c.length>1&&t.jsxDEV(Y,{id:`planned-route-${i}`,type:"geojson",data:_,children:t.jsxDEV(G,{...X},void 0,!1,{fileName:"C:/Users/sarkc/Desktop/Ayanda/Bus-Connect/client/src/components/LiveMap.tsx",lineNumber:415,columnNumber:25},this)},void 0,!1,{fileName:"C:/Users/sarkc/Desktop/Ayanda/Bus-Connect/client/src/components/LiveMap.tsx",lineNumber:414,columnNumber:21},this),I.length>1&&t.jsxDEV(Y,{id:`remaining-route-${i}`,type:"geojson",data:Q,children:t.jsxDEV(G,{...Z},void 0,!1,{fileName:"C:/Users/sarkc/Desktop/Ayanda/Bus-Connect/client/src/components/LiveMap.tsx",lineNumber:422,columnNumber:25},this)},void 0,!1,{fileName:"C:/Users/sarkc/Desktop/Ayanda/Bus-Connect/client/src/components/LiveMap.tsx",lineNumber:421,columnNumber:21},this),d?.stops?.filter(e=>e.location?.lat&&e.location?.lng).map((e,s)=>t.jsxDEV($,{longitude:e.location.lng,latitude:e.location.lat,anchor:"center",children:t.jsxDEV("div",{className:"w-2.5 h-2.5 bg-white border-2 border-blue-600 rounded-full shadow-sm"},void 0,!1,{fileName:"C:/Users/sarkc/Desktop/Ayanda/Bus-Connect/client/src/components/LiveMap.tsx",lineNumber:434,columnNumber:25},this)},s,!1,{fileName:"C:/Users/sarkc/Desktop/Ayanda/Bus-Connect/client/src/components/LiveMap.tsx",lineNumber:428,columnNumber:21},this)),u&&t.jsxDEV($,{longitude:u[0],latitude:u[1],anchor:"center",children:t.jsxDEV("div",{className:"w-4 h-4 bg-red-500 border-2 border-white rounded-full shadow-lg flex items-center justify-center",children:t.jsxDEV("div",{className:"w-1.5 h-1.5 bg-white rounded-full"},void 0,!1,{fileName:"C:/Users/sarkc/Desktop/Ayanda/Bus-Connect/client/src/components/LiveMap.tsx",lineNumber:446,columnNumber:29},this)},void 0,!1,{fileName:"C:/Users/sarkc/Desktop/Ayanda/Bus-Connect/client/src/components/LiveMap.tsx",lineNumber:445,columnNumber:25},this)},void 0,!1,{fileName:"C:/Users/sarkc/Desktop/Ayanda/Bus-Connect/client/src/components/LiveMap.tsx",lineNumber:440,columnNumber:21},this),t.jsxDEV($,{longitude:l[0],latitude:l[1],anchor:"center",rotation:M,children:t.jsxDEV("div",{className:"relative cursor-pointer",children:[t.jsxDEV("div",{className:"absolute -inset-5 rounded-full bus-pulse-ring"},void 0,!1,{fileName:"C:/Users/sarkc/Desktop/Ayanda/Bus-Connect/client/src/components/LiveMap.tsx",lineNumber:460,columnNumber:25},this),t.jsxDEV("div",{className:"absolute -inset-3 bg-blue-500/20 rounded-full animate-pulse"},void 0,!1,{fileName:"C:/Users/sarkc/Desktop/Ayanda/Bus-Connect/client/src/components/LiveMap.tsx",lineNumber:462,columnNumber:25},this),t.jsxDEV("div",{className:"relative z-10 w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl shadow-2xl shadow-blue-600/50 border-[3px] border-white flex items-center justify-center bus-bounce",children:t.jsxDEV("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",strokeLinecap:"round",strokeLinejoin:"round",className:"w-6 h-6 text-white drop-shadow-md",children:[t.jsxDEV("path",{d:"M8 6v6"},void 0,!1,{fileName:"C:/Users/sarkc/Desktop/Ayanda/Bus-Connect/client/src/components/LiveMap.tsx",lineNumber:467,columnNumber:33},this),t.jsxDEV("path",{d:"M16 6v6"},void 0,!1,{fileName:"C:/Users/sarkc/Desktop/Ayanda/Bus-Connect/client/src/components/LiveMap.tsx",lineNumber:468,columnNumber:33},this),t.jsxDEV("path",{d:"M2 12h20"},void 0,!1,{fileName:"C:/Users/sarkc/Desktop/Ayanda/Bus-Connect/client/src/components/LiveMap.tsx",lineNumber:469,columnNumber:33},this),t.jsxDEV("path",{d:"M18 18h3s.5-1.7.8-2.8c.1-.4.2-.8.2-1.2 0-2.8-2-5-6-5H8c-4 0-6 2.2-6 5 0 .4.1.8.2 1.2.3 1.1.8 2.8.8 2.8h3"},void 0,!1,{fileName:"C:/Users/sarkc/Desktop/Ayanda/Bus-Connect/client/src/components/LiveMap.tsx",lineNumber:470,columnNumber:33},this),t.jsxDEV("circle",{cx:"7",cy:"18",r:"2"},void 0,!1,{fileName:"C:/Users/sarkc/Desktop/Ayanda/Bus-Connect/client/src/components/LiveMap.tsx",lineNumber:471,columnNumber:33},this),t.jsxDEV("circle",{cx:"17",cy:"18",r:"2"},void 0,!1,{fileName:"C:/Users/sarkc/Desktop/Ayanda/Bus-Connect/client/src/components/LiveMap.tsx",lineNumber:472,columnNumber:33},this)]},void 0,!0,{fileName:"C:/Users/sarkc/Desktop/Ayanda/Bus-Connect/client/src/components/LiveMap.tsx",lineNumber:466,columnNumber:29},this)},void 0,!1,{fileName:"C:/Users/sarkc/Desktop/Ayanda/Bus-Connect/client/src/components/LiveMap.tsx",lineNumber:465,columnNumber:25},this),t.jsxDEV("div",{className:"absolute -top-4 left-1/2 -translate-x-1/2 z-20",children:t.jsxDEV("div",{className:"w-0 h-0 border-l-[7px] border-l-transparent border-r-[7px] border-r-transparent border-b-[10px] border-b-indigo-600 drop-shadow-sm"},void 0,!1,{fileName:"C:/Users/sarkc/Desktop/Ayanda/Bus-Connect/client/src/components/LiveMap.tsx",lineNumber:478,columnNumber:29},this)},void 0,!1,{fileName:"C:/Users/sarkc/Desktop/Ayanda/Bus-Connect/client/src/components/LiveMap.tsx",lineNumber:477,columnNumber:25},this)]},void 0,!0,{fileName:"C:/Users/sarkc/Desktop/Ayanda/Bus-Connect/client/src/components/LiveMap.tsx",lineNumber:458,columnNumber:21},this)},void 0,!1,{fileName:"C:/Users/sarkc/Desktop/Ayanda/Bus-Connect/client/src/components/LiveMap.tsx",lineNumber:452,columnNumber:17},this)]},void 0,!0,{fileName:"C:/Users/sarkc/Desktop/Ayanda/Bus-Connect/client/src/components/LiveMap.tsx",lineNumber:400,columnNumber:13},this),t.jsxDEV("div",{className:"absolute bottom-4 right-4 z-[1000] flex flex-col items-end gap-3",children:[l&&t.jsxDEV("button",{onClick:()=>R(l),className:"p-2.5 bg-white rounded-full shadow-md border border-slate-100 text-slate-600 hover:bg-slate-50 hover:text-blue-600 transition-all active:scale-95",title:"Recenter on Bus",children:t.jsxDEV("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[t.jsxDEV("circle",{cx:"12",cy:"12",r:"10"},void 0,!1,{fileName:"C:/Users/sarkc/Desktop/Ayanda/Bus-Connect/client/src/components/LiveMap.tsx",lineNumber:493,columnNumber:29},this),t.jsxDEV("circle",{cx:"12",cy:"12",r:"3"},void 0,!1,{fileName:"C:/Users/sarkc/Desktop/Ayanda/Bus-Connect/client/src/components/LiveMap.tsx",lineNumber:494,columnNumber:29},this),t.jsxDEV("path",{d:"M12 2v2"},void 0,!1,{fileName:"C:/Users/sarkc/Desktop/Ayanda/Bus-Connect/client/src/components/LiveMap.tsx",lineNumber:495,columnNumber:29},this),t.jsxDEV("path",{d:"M12 20v2"},void 0,!1,{fileName:"C:/Users/sarkc/Desktop/Ayanda/Bus-Connect/client/src/components/LiveMap.tsx",lineNumber:496,columnNumber:29},this),t.jsxDEV("path",{d:"M2 12h2"},void 0,!1,{fileName:"C:/Users/sarkc/Desktop/Ayanda/Bus-Connect/client/src/components/LiveMap.tsx",lineNumber:497,columnNumber:29},this),t.jsxDEV("path",{d:"M20 12h2"},void 0,!1,{fileName:"C:/Users/sarkc/Desktop/Ayanda/Bus-Connect/client/src/components/LiveMap.tsx",lineNumber:498,columnNumber:29},this)]},void 0,!0,{fileName:"C:/Users/sarkc/Desktop/Ayanda/Bus-Connect/client/src/components/LiveMap.tsx",lineNumber:492,columnNumber:25},this)},void 0,!1,{fileName:"C:/Users/sarkc/Desktop/Ayanda/Bus-Connect/client/src/components/LiveMap.tsx",lineNumber:487,columnNumber:21},this),t.jsxDEV("div",{className:"bg-white dark:bg-slate-900 px-3 py-1.5 rounded-full shadow-lg border border-slate-100 dark:border-slate-800 flex items-center gap-2",children:[t.jsxDEV("div",{className:`w-2 h-2 ${P?"bg-green-500":"bg-red-500"} rounded-full animate-pulse`},void 0,!1,{fileName:"C:/Users/sarkc/Desktop/Ayanda/Bus-Connect/client/src/components/LiveMap.tsx",lineNumber:505,columnNumber:21},this),t.jsxDEV("span",{className:"text-[10px] font-bold text-slate-600 dark:text-slate-300 uppercase tracking-wider",children:P?"Live Tracking":"Connecting..."},void 0,!1,{fileName:"C:/Users/sarkc/Desktop/Ayanda/Bus-Connect/client/src/components/LiveMap.tsx",lineNumber:506,columnNumber:21},this)]},void 0,!0,{fileName:"C:/Users/sarkc/Desktop/Ayanda/Bus-Connect/client/src/components/LiveMap.tsx",lineNumber:504,columnNumber:17},this)]},void 0,!0,{fileName:"C:/Users/sarkc/Desktop/Ayanda/Bus-Connect/client/src/components/LiveMap.tsx",lineNumber:484,columnNumber:13},this)]},void 0,!0,{fileName:"C:/Users/sarkc/Desktop/Ayanda/Bus-Connect/client/src/components/LiveMap.tsx",lineNumber:399,columnNumber:9},this)}export{me as default};

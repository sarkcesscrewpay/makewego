import { createRequire } from 'module'; const require = createRequire(import.meta.url);
var zt=Object.defineProperty;var me=(l,e)=>()=>(l&&(e=l(l=0)),e);var _e=(l,e)=>{for(var n in e)zt(l,n,{get:e[n],enumerable:!0})};var Ye={};_e(Ye,{bookings:()=>S,busStops:()=>z,buses:()=>be,insertBookingSchema:()=>He,insertBusSchema:()=>Re,insertProfileSchema:()=>qt,insertRouteSchema:()=>We,insertScheduleSchema:()=>Ge,insertUserSchema:()=>Jt,notificationPreferences:()=>ee,notifications:()=>P,payments:()=>Yt,profiles:()=>pe,pushSubscriptions:()=>Q,reports:()=>le,rideRequests:()=>G,routeStops:()=>oe,routes:()=>B,schedules:()=>f,sosAlerts:()=>Ke,supportTickets:()=>C,users:()=>b});import{mysqlTable as O,int as T,varchar as w,text as q,boolean as J,datetime as R,decimal as V,json as ne}from"drizzle-orm/mysql-core";import{sql as U}from"drizzle-orm";import{createInsertSchema as fe}from"drizzle-zod";var b,be,B,oe,f,S,pe,z,Yt,C,P,Q,ee,G,le,Ke,Jt,Re,We,Ge,He,qt,Se=me(()=>{"use strict";b=O("users",{id:T("id").autoincrement().primaryKey(),email:w("email",{length:255}).notNull().unique(),password:w("password",{length:255}).notNull(),firstName:w("first_name",{length:100}).notNull(),lastName:w("last_name",{length:100}).notNull(),phone:w("phone",{length:20}),phoneVerified:J("phone_verified").default(!1),phoneVerificationCode:w("phone_verification_code",{length:10}),phoneVerificationExpiry:R("phone_verification_expiry"),role:w("role",{length:20}).notNull().default("passenger"),isLive:J("is_live").default(!1),emailVerified:J("email_verified").default(!1),verificationToken:w("verification_token",{length:255}),verificationTokenExpiry:R("verification_token_expiry"),driverDetails:ne("driver_details").$type(),kycStatus:w("kyc_status",{length:20}),kycSubmittedAt:R("kyc_submitted_at"),kycReviewedAt:R("kyc_reviewed_at"),kycReviewedBy:w("kyc_reviewed_by",{length:20}),kycRejectionReason:q("kyc_rejection_reason"),licenseDocumentUrl:w("license_document_url",{length:500}),accountStatus:w("account_status",{length:20}).default("active"),suspensionReason:q("suspension_reason"),staffType:w("staff_type",{length:30}),createdAt:R("created_at").default(U`NOW()`),updatedAt:R("updated_at").default(U`NOW()`)}),be=O("buses",{id:T("id").autoincrement().primaryKey(),plateNumber:w("plate_number",{length:20}).notNull().unique(),driverName:w("driver_name",{length:200}).notNull(),capacity:T("capacity").notNull(),status:w("status",{length:20}).notNull().default("active")}),B=O("routes",{id:T("id").autoincrement().primaryKey(),name:w("name",{length:255}).notNull(),startLocation:w("start_location",{length:255}).notNull(),endLocation:w("end_location",{length:255}).notNull(),distance:w("distance",{length:20}),estimatedDuration:T("estimated_duration"),busType:w("bus_type",{length:30}).default("standard"),geometry:ne("geometry"),createdAt:R("created_at").default(U`NOW()`)}),oe=O("route_stops",{id:T("id").autoincrement().primaryKey(),routeId:T("route_id").notNull().references(()=>B.id,{onDelete:"cascade"}),name:w("name",{length:255}).notNull(),lat:V("lat",{precision:10,scale:6}),lng:V("lng",{precision:10,scale:6}),stopOrder:T("stop_order").notNull()}),f=O("schedules",{id:T("id").autoincrement().primaryKey(),routeId:T("route_id").references(()=>B.id),driverId:T("driver_id").references(()=>b.id),departureTime:R("departure_time").notNull(),price:V("price",{precision:10,scale:2}),capacity:T("capacity").default(15),availableSeats:T("available_seats"),isLive:J("is_live").default(!1),routeData:ne("route_data"),fareBreakdown:ne("fare_breakdown"),lastLocationLat:V("last_location_lat",{precision:10,scale:6}),lastLocationLng:V("last_location_lng",{precision:10,scale:6}),lastUpdate:R("last_update"),startLocation:w("start_location",{length:255}),endLocation:w("end_location",{length:255}),stopsData:ne("stops_data"),createdAt:R("created_at").default(U`NOW()`)}),S=O("bookings",{id:T("id").autoincrement().primaryKey(),userId:T("user_id").notNull().references(()=>b.id),scheduleId:T("schedule_id").notNull().references(()=>f.id),seatNumber:T("seat_number"),pickup:w("pickup",{length:255}),dropoff:w("dropoff",{length:255}),price:V("price",{precision:10,scale:2}),status:w("status",{length:20}).notNull().default("confirmed"),isGroupBooking:J("is_group_booking").default(!1),numberOfSeats:T("number_of_seats"),organizationName:w("organization_name",{length:255}),organizationType:w("organization_type",{length:50}),contactName:w("contact_name",{length:200}),contactPhone:w("contact_phone",{length:20}),notes:q("notes"),rideRequestId:T("ride_request_id"),createdAt:R("created_at").default(U`NOW()`)}),pe=O("profiles",{id:T("id").autoincrement().primaryKey(),userId:T("user_id").notNull().references(()=>b.id),role:w("role",{length:20}).notNull().default("passenger"),phoneNumber:w("phone_number",{length:20}),createdAt:R("created_at").default(U`NOW()`)}),z=O("bus_stops",{id:T("id").autoincrement().primaryKey(),name:w("name",{length:255}).notNull(),city:w("city",{length:100}).notNull(),region:w("region",{length:100}).notNull(),type:w("type",{length:20}).notNull(),lat:V("lat",{precision:10,scale:6}).notNull(),lng:V("lng",{precision:10,scale:6}).notNull(),aliases:ne("aliases").$type(),searchTerms:q("search_terms"),createdAt:R("created_at").default(U`NOW()`),updatedAt:R("updated_at").default(U`NOW()`)}),Yt=O("payments",{id:T("id").autoincrement().primaryKey(),bookingId:T("booking_id").notNull().references(()=>S.id),amount:V("amount",{precision:10,scale:2}).notNull(),status:w("status",{length:20}).notNull().default("completed"),method:w("method",{length:30}).notNull(),createdAt:R("created_at").default(U`NOW()`)}),C=O("support_tickets",{id:T("id").autoincrement().primaryKey(),userId:T("user_id").notNull().references(()=>b.id),userEmail:w("user_email",{length:255}).notNull(),userName:w("user_name",{length:200}).notNull(),subject:w("subject",{length:255}).notNull(),message:q("message").notNull(),status:w("status",{length:20}).notNull().default("open"),priority:w("priority",{length:20}).notNull().default("medium"),category:w("category",{length:30}).notNull().default("other"),resolvedAt:R("resolved_at"),adminNotes:q("admin_notes"),assignedTo:w("assigned_to",{length:20}),createdAt:R("created_at").default(U`NOW()`),updatedAt:R("updated_at").default(U`NOW()`)}),P=O("notifications",{id:T("id").autoincrement().primaryKey(),userId:T("user_id").notNull().references(()=>b.id),type:w("type",{length:30}).notNull(),title:w("title",{length:255}).notNull(),body:q("body").notNull(),data:ne("data"),isRead:J("is_read").default(!1),sent:J("sent").default(!1),sentAt:R("sent_at"),createdAt:R("created_at").default(U`NOW()`)}),Q=O("push_subscriptions",{id:T("id").autoincrement().primaryKey(),userId:T("user_id").notNull().references(()=>b.id),endpoint:q("endpoint").notNull(),keys:ne("keys").$type().notNull(),createdAt:R("created_at").default(U`NOW()`)}),ee=O("notification_preferences",{id:T("id").autoincrement().primaryKey(),userId:T("user_id").notNull().references(()=>b.id),enablePushNotifications:J("enable_push_notifications").default(!0),enableArrivalAlerts:J("enable_arrival_alerts").default(!0),enableDelayAlerts:J("enable_delay_alerts").default(!0),enableCongestionWarnings:J("enable_congestion_warnings").default(!0),arrivalAlertMinutes:T("arrival_alert_minutes").default(10),delayThresholdMinutes:T("delay_threshold_minutes").default(15),createdAt:R("created_at").default(U`NOW()`),updatedAt:R("updated_at").default(U`NOW()`)}),G=O("ride_requests",{id:T("id").autoincrement().primaryKey(),userId:T("user_id").notNull().references(()=>b.id),userName:w("user_name",{length:200}),userPhone:w("user_phone",{length:20}),fromLocation:w("from_location",{length:255}).notNull(),toLocation:w("to_location",{length:255}).notNull(),seats:T("seats").default(1),departureTime:R("departure_time"),notes:q("notes"),status:w("status",{length:20}).notNull().default("pending"),estimatedFare:V("estimated_fare",{precision:10,scale:2}),estimatedDistance:V("estimated_distance",{precision:10,scale:2}),notifiedDrivers:ne("notified_drivers").$type(),acceptedBy:T("accepted_by").references(()=>b.id),acceptedByName:w("accepted_by_name",{length:200}),acceptedScheduleId:T("accepted_schedule_id"),acceptedAt:R("accepted_at"),cancelledAt:R("cancelled_at"),createdAt:R("created_at").default(U`NOW()`)}),le=O("reports",{id:T("id").autoincrement().primaryKey(),userId:T("user_id").notNull().references(()=>b.id),type:w("type",{length:50}).notNull(),scheduleId:T("schedule_id"),routeId:T("route_id"),details:q("details"),locationLat:V("location_lat",{precision:10,scale:6}),locationLng:V("location_lng",{precision:10,scale:6}),status:w("status",{length:20}).default("pending"),createdAt:R("created_at").default(U`NOW()`)}),Ke=O("sos_alerts",{id:T("id").autoincrement().primaryKey(),userId:T("user_id").notNull().references(()=>b.id),scheduleId:T("schedule_id"),locationLat:V("location_lat",{precision:10,scale:6}),locationLng:V("location_lng",{precision:10,scale:6}),message:q("message"),status:w("status",{length:20}).default("active"),createdAt:R("created_at").default(U`NOW()`)}),Jt=fe(b).omit({id:!0,createdAt:!0,updatedAt:!0}),Re=fe(be).omit({id:!0}),We=fe(B).omit({id:!0,createdAt:!0}),Ge=fe(f).omit({id:!0,createdAt:!0}),He=fe(S).omit({id:!0,createdAt:!0}),qt=fe(pe).omit({id:!0,createdAt:!0})});import"dotenv/config";import{drizzle as Qt}from"drizzle-orm/mysql2";import Xt from"mysql2/promise";async function mt(){try{let l=await dt.getConnection();return await l.ping(),l.release(),console.log("\u2705 Connected to MySQL database"),!0}catch(l){return console.error(`
\u274C MySQL Connection Failed!`),console.error("Error:",l.message),l.code==="ECONNREFUSED"?(console.error(`
\u{1F50D} Cause: Connection refused`),console.error("Check that your MySQL server is running and DATABASE_URL is correct.")):l.code==="ER_ACCESS_DENIED_ERROR"?(console.error(`
\u{1F50D} Cause: Authentication failed`),console.error("Check your DATABASE_URL username and password.")):l.code==="ER_BAD_DB_ERROR"?(console.error(`
\u{1F50D} Cause: Database not found`),console.error("Create the database on your MySQL server first.")):l.code==="ETIMEDOUT"&&(console.error(`
\u{1F50D} Cause: Connection timed out`),console.error("Check your network connectivity and firewall rules.")),console.error(`
\u{1F4CB} Fix steps:`),console.error("1. Verify DATABASE_URL in your .env file"),console.error("2. Ensure MySQL server is running"),console.error(`3. Run 'npx drizzle-kit push' to create tables
`),!1}}var dt,m,ke=me(()=>{"use strict";Se();if(!process.env.DATABASE_URL)throw new Error("DATABASE_URL must be set in your .env file");dt=Xt.createPool({uri:process.env.DATABASE_URL,waitForConnections:!0,connectionLimit:10,queueLimit:0}),m=Qt(dt,{schema:Ye,mode:"default"})});var pt={};_e(pt,{MySQLStorage:()=>Le,storage:()=>h});import{eq as g,and as $,or as ae,like as K,sql as L,desc as te,asc as De,inArray as Zt,gte as Je,count as se}from"drizzle-orm";import ft from"bcrypt";function I(l){if(typeof l=="number")return l;let e=parseInt(l,10);if(isNaN(e))throw new Error(`Invalid ID: ${l}`);return e}function _(l){return{...l,_id:l.id}}var Le,h,qe=me(()=>{"use strict";ke();Se();Le=class{async getBuses(){return(await m.select().from(be)).map(_)}async createBus(e){let[n]=await m.insert(be).values({plateNumber:e.plateNumber,driverName:e.driverName,capacity:e.capacity,status:e.status||"active"}),o=n.insertId;return{_id:o,id:o,...e}}async getRoutes(){let e=await m.select().from(B);return await Promise.all(e.map(async o=>{let a=await m.select().from(oe).where(g(oe.routeId,o.id)).orderBy(De(oe.stopOrder));return{..._(o),stops:a.map(i=>({name:i.name,location:i.lat&&i.lng?{lat:parseFloat(String(i.lat)),lng:parseFloat(String(i.lng))}:null,order:i.stopOrder}))}}))}async createRoute(e){let[n]=await m.insert(B).values({name:e.name,startLocation:e.startLocation,endLocation:e.endLocation,distance:e.distance||null,estimatedDuration:e.estimatedDuration||null,busType:e.busType||"standard",geometry:e.geometry||null}),o=n.insertId;if(e.stops&&Array.isArray(e.stops))for(let a=0;a<e.stops.length;a++){let i=e.stops[a];await m.insert(oe).values({routeId:o,name:typeof i=="string"?i:i.name,lat:i.location?.lat?.toString()||i.lat?.toString()||null,lng:i.location?.lng?.toString()||i.lng?.toString()||null,stopOrder:i.order??a})}return{_id:o,id:o,name:e.name,startLocation:e.startLocation,endLocation:e.endLocation,distance:e.distance,estimatedDuration:e.estimatedDuration,busType:e.busType,geometry:e.geometry,stops:e.stops||[]}}async getRoute(e){if(!e)return null;let n=I(e),[o]=await m.select().from(B).where(g(B.id,n));if(!o)return null;let a=await m.select().from(oe).where(g(oe.routeId,n)).orderBy(De(oe.stopOrder));return{..._(o),stops:a.map(i=>({name:i.name,location:i.lat&&i.lng?{lat:parseFloat(String(i.lat)),lng:parseFloat(String(i.lng))}:null,order:i.stopOrder}))}}async searchRoutes(e){let n=[];e?.query&&n.push(ae(K(B.name,`%${e.query}%`),K(B.startLocation,`%${e.query}%`),K(B.endLocation,`%${e.query}%`))),e?.start&&n.push(K(B.startLocation,`%${e.start}%`)),e?.end&&n.push(K(B.endLocation,`%${e.end}%`)),e?.busType&&n.push(g(B.busType,e.busType));let o;return n.length>0?o=m.select().from(B).where($(...n)):o=m.select().from(B),(await o).map(_)}async getSchedules(e){let n=[];if(e?.driverId){let r=I(e.driverId);n.push(g(f.driverId,r))}let o;n.length>0?o=await m.select().from(f).where($(...n)):o=await m.select().from(f);let a=await Promise.all(o.map(async r=>{let s=null,t=r.routeData||null;if(typeof t=="string")try{t=JSON.parse(t)}catch(u){console.error("Failed to parse routeData JSON:",u),t=null}if(!t&&r.routeId&&(t=await this.getRoute(r.routeId)),r.driverId){let[u]=await m.select().from(b).where(g(b.id,r.driverId));u&&(s={firstName:u.firstName,lastName:u.lastName,isLive:!!u.isLive,vehicle:u.driverDetails?.vehicleParams||null})}let c=r.stopsData;if(typeof c=="string")try{c=JSON.parse(c)}catch(u){console.error("Failed to parse stopsData JSON:",u),c=null}return c=(Array.isArray(c)?c:[])||t?.stops||[],{..._(r),_id:r.id,driver:s,route:t,stops:c,isLive:!!r.isLive,price:r.price?parseFloat(String(r.price)):0,lastLocationLat:r.lastLocationLat?parseFloat(String(r.lastLocationLat)):null,lastLocationLng:r.lastLocationLng?parseFloat(String(r.lastLocationLng)):null}})),i=a;if((e?.from||e?.to||e?.query)&&(i=a.filter(r=>{let s=(r.startLocation||r.route?.startLocation||"").toLowerCase(),t=(r.endLocation||r.route?.endLocation||"").toLowerCase(),c=r.stops||[],u=[s,t,...c.map(d=>(typeof d=="string"?d:d?.name||"").toLowerCase()),r.driver?.firstName?.toLowerCase()||"",r.driver?.lastName?.toLowerCase()||""];if(e.from){let d=e.from.toLowerCase();if(!u.some(v=>v.includes(d)||d.includes(v)))return!1}if(e.to){let d=e.to.toLowerCase();if(!u.some(v=>v.includes(d)||d.includes(v)))return!1}if(e.query){let d=e.query.toLowerCase();if(!u.some(v=>v.includes(d)))return!1}return!0})),!e?.driverId){let r=new Date,s=new Date(r.getTime()-1440*60*1e3);i=i.filter(t=>{let c=t.isLive||t.driver?.isLive,u=t.departureTime?new Date(t.departureTime):null;return c?!0:!(u&&u.getTime()<s.getTime())})}return(e?.from||e?.to)&&(i=i.filter(r=>{if(e.driverId)return!0;let s=r.stops||[],t=(r.startLocation||r.route?.startLocation||"").toLowerCase(),c=(r.endLocation||r.route?.endLocation||"").toLowerCase();if(s.length===0){if(e.from){let j=e.from.toLowerCase();if(!t.includes(j)&&!j.includes(t))return!1}if(e.to){let j=e.to.toLowerCase();if(!c.includes(j)&&!j.includes(c))return!1}return!0}let u=e.from?s.findIndex(j=>{let W=(typeof j=="string"?j:j?.name||"").toLowerCase(),Z=e.from.toLowerCase();return W.includes(Z)||Z.includes(W)}):0,d=(e.from||"").toLowerCase(),p=d&&(t.includes(d)||d.includes(t)),v=u!==-1?u:p?0:-1,y=e.to?s.findIndex(j=>{let W=(typeof j=="string"?j:j?.name||"").toLowerCase(),Z=e.to.toLowerCase();return W.includes(Z)||Z.includes(W)}):s.length-1,N=(e.to||"").toLowerCase(),A=N&&(c.includes(N)||N.includes(c)),k=y!==-1?y:A?s.length>0?s.length-1:0:-1;return!(v===-1||k===-1||v>=k&&s.length>0)})),i}async createSchedule(e){let n=e.routeId?I(e.routeId):null,o=e.driverId?I(e.driverId):null,[a]=await m.insert(f).values({routeId:n,driverId:o,departureTime:e.departureTime instanceof Date?e.departureTime:new Date(e.departureTime),price:e.price?.toString()||"0",capacity:e.capacity||15,availableSeats:e.availableSeats??e.capacity??15,isLive:e.isLive||!1,routeData:e.route||null,fareBreakdown:e.fareBreakdown||null,startLocation:e.route?.startLocation||e.startLocation||null,endLocation:e.route?.endLocation||e.endLocation||null,stopsData:e.stops||null}),i=a.insertId;return{_id:i,id:i,routeId:n,driverId:o,departureTime:e.departureTime,price:e.price,capacity:e.capacity||15,availableSeats:e.availableSeats??e.capacity??15,isLive:e.isLive||!1,route:e.route||null,fareBreakdown:e.fareBreakdown||null,startLocation:e.route?.startLocation||e.startLocation||null,endLocation:e.route?.endLocation||e.endLocation||null,stops:e.stops||null}}async getSchedule(e){if(!e)return null;let n=I(e),[o]=await m.select().from(f).where(g(f.id,n));if(!o)return null;let a=o.routeData||null;return!a&&o.routeId&&(a=await this.getRoute(o.routeId)),{..._(o),route:a,stops:o.stopsData||a?.stops||[],price:o.price?parseFloat(String(o.price)):0,isLive:!!o.isLive,lastLocationLat:o.lastLocationLat?parseFloat(String(o.lastLocationLat)):null,lastLocationLng:o.lastLocationLng?parseFloat(String(o.lastLocationLng)):null}}async deleteSchedule(e){let n=I(e),[o]=await m.delete(f).where(g(f.id,n));return o.affectedRows>0}async updateScheduleLocation(e,n){let o=I(e);await m.update(f).set({lastLocationLat:n.lat.toString(),lastLocationLng:n.lng.toString(),lastUpdate:new Date}).where(g(f.id,o))}async getBookings(e){let n=I(e),o=await m.select().from(S).where(g(S.userId,n)).orderBy(te(S.createdAt));return(await Promise.all(o.map(async i=>{let r=null,s=null,t=null;if(i.scheduleId){let[c]=await m.select().from(f).where(g(f.id,i.scheduleId));if(c&&(r=c,t=c.routeData||null,!t&&c.routeId&&(t=await this.getRoute(c.routeId)),c.driverId)){let[u]=await m.select().from(b).where(g(b.id,c.driverId));u&&(s={firstName:u.firstName,lastName:u.lastName,phone:u.phoneVerified?u.phone:null,phoneVerified:u.phoneVerified||!1,vehicle:u.driverDetails?.vehicleParams||null})}}return r?{..._(i),price:i.price?parseFloat(String(i.price)):0,schedule:{_id:r.id,id:r.id,departureTime:r.departureTime,price:r.price?parseFloat(String(r.price)):0,driver:s},route:t||{startLocation:r.startLocation||"Unknown",endLocation:r.endLocation||"Unknown"}}:{..._(i),price:i.price?parseFloat(String(i.price)):0,schedule:{departureTime:new Date,price:0},route:{startLocation:"Unknown (Deleted)",endLocation:"Unknown (Deleted)"}}}))).sort((i,r)=>{let s=new Date(i.schedule?.departureTime||0).getTime();return new Date(r.schedule?.departureTime||0).getTime()-s})}async createBooking(e){let n=I(e.scheduleId),o=I(e.userId);return{...await m.transaction(async i=>{let[r]=await i.select().from(f).where(g(f.id,n)).for("update");if(!r||!r.availableSeats||r.availableSeats<=0)throw new Error("No seats available for this schedule");await i.update(f).set({availableSeats:L`${f.availableSeats} - 1`}).where(g(f.id,n));let[s]=await i.insert(S).values({userId:o,scheduleId:n,seatNumber:e.seatNumber||null,pickup:e.pickup||null,dropoff:e.dropoff||null,price:e.price?.toString()||"0",status:e.status||"confirmed",isGroupBooking:e.isGroupBooking||!1,numberOfSeats:e.numberOfSeats||null,organizationName:e.organizationName||null,organizationType:e.organizationType||null,contactName:e.contactName||null,contactPhone:e.contactPhone||null,notes:e.notes||null,rideRequestId:e.rideRequestId?I(e.rideRequestId):null}),t=s.insertId;return{_id:t,id:t}}),...e,userId:o,scheduleId:n}}async cancelBooking(e,n){let o=I(e),a=I(n),[i]=await m.select().from(S).where(g(S.id,o));if(!i)return null;await m.update(S).set({status:"cancelled"}).where(g(S.id,o)),i.status==="confirmed"&&i.scheduleId&&await m.update(f).set({availableSeats:L`${f.availableSeats} + 1`}).where(g(f.id,i.scheduleId));let[r]=await m.select().from(S).where(g(S.id,o));return r?_(r):null}async deleteBooking(e){let n=I(e),[o]=await m.select().from(S).where(g(S.id,n));o&&o.status==="confirmed"&&o.scheduleId&&await m.update(f).set({availableSeats:L`${f.availableSeats} + 1`}).where(g(f.id,o.scheduleId));let[a]=await m.delete(S).where(g(S.id,n));return a.affectedRows>0}async markScheduleBookingsCompleted(e){let n=I(e);await m.update(S).set({status:"completed"}).where(g(S.scheduleId,n))}async getAllBookings(e){let n=e?.page||1,o=e?.limit||20,a=(n-1)*o,i=[];e?.status&&e.status!=="all"&&i.push(g(S.status,e.status));let r=i.length>0?$(...i):void 0,[s,t]=await Promise.all([r?m.select().from(S).where(r).orderBy(te(S.createdAt)).limit(o).offset(a):m.select().from(S).orderBy(te(S.createdAt)).limit(o).offset(a),r?m.select({cnt:se()}).from(S).where(r):m.select({cnt:se()}).from(S)]),c=t[0]?.cnt||0;return{bookings:await Promise.all(s.map(async d=>{let p=null,v=null;if(d.userId){let[y]=await m.select().from(b).where(g(b.id,d.userId));y&&(p={firstName:y.firstName,lastName:y.lastName,email:y.email,phone:y.phone||null,phoneVerified:y.phoneVerified||!1})}if(d.scheduleId){let[y]=await m.select().from(f).where(g(f.id,d.scheduleId));y&&(v={..._(y),route:y.routeData,price:y.price?parseFloat(String(y.price)):0})}return{..._(d),user:p,schedule:v}})),total:c}}async getProfile(e){let n=I(e),[o]=await m.select().from(pe).where(g(pe.userId,n));return o?_(o):null}async createProfile(e,n){let o=I(e),[a]=await m.insert(pe).values({userId:o,role:n.role||"passenger",phoneNumber:n.phoneNumber||null}),i=a.insertId;return{_id:i,id:i,userId:o,role:n.role||"passenger",createdAt:new Date}}async getBusStops(){return(await m.select().from(z)).map(n=>({..._(n),lat:n.lat?parseFloat(String(n.lat)):null,lng:n.lng?parseFloat(String(n.lng)):null,location:n.lat&&n.lng?{lat:parseFloat(String(n.lat)),lng:parseFloat(String(n.lng))}:null,latitude:n.lat?parseFloat(String(n.lat)):null,longitude:n.lng?parseFloat(String(n.lng)):null}))}async searchBusStops(e,n){let o=[ae(K(z.name,`%${e}%`),K(z.city,`%${e}%`),K(z.region,`%${e}%`),K(z.searchTerms,`%${e}%`))];return n&&n!=="All Regions"&&o.push(g(z.region,n)),(await m.select().from(z).where($(...o)).orderBy(De(z.type)).limit(15)).map(i=>({..._(i),lat:i.lat?parseFloat(String(i.lat)):null,lng:i.lng?parseFloat(String(i.lng)):null,location:i.lat&&i.lng?{lat:parseFloat(String(i.lat)),lng:parseFloat(String(i.lng))}:null}))}async findBusStopByName(e){let n=await m.select().from(z).where(ae(K(z.name,e),K(z.city,e))).limit(1);if(n.length===0)return null;let o=n[0];return{..._(o),lat:o.lat?parseFloat(String(o.lat)):null,lng:o.lng?parseFloat(String(o.lng)):null,location:o.lat&&o.lng?{lat:parseFloat(String(o.lat)),lng:parseFloat(String(o.lng))}:null}}async clearBusStops(){await m.delete(z)}async createBusStop(e){let[n]=await m.insert(z).values({name:e.name,city:e.city,region:e.region,type:e.type,lat:e.location?.lat?.toString()||e.lat?.toString()||null,lng:e.location?.lng?.toString()||e.lng?.toString()||null,aliases:e.aliases||null,searchTerms:e.searchTerms||null});return{id:n.insertId,...e}}async createUser(e){let n=await ft.hash(e.password,10),[o]=await m.insert(b).values({email:e.email,password:n,firstName:e.firstName,lastName:e.lastName,phone:e.phone||null,phoneVerified:e.phoneVerified??!1,role:e.role||"passenger",driverDetails:e.driverDetails||null,emailVerified:e.emailVerified??!1,verificationToken:e.verificationToken||null,verificationTokenExpiry:e.verificationTokenExpiry||null,isLive:!1,accountStatus:e.accountStatus||"active",kycStatus:e.role==="driver"?"pending":null,kycSubmittedAt:e.role==="driver"?new Date:null}),a=o.insertId;return{_id:a,id:a,email:e.email,password:n,firstName:e.firstName,lastName:e.lastName,phone:e.phone||null,phoneVerified:e.phoneVerified??!1,role:e.role||"passenger",driverDetails:e.driverDetails||null,emailVerified:e.emailVerified??!1,verificationToken:e.verificationToken||null,verificationTokenExpiry:e.verificationTokenExpiry||null,isLive:!1,createdAt:new Date,updatedAt:new Date}}async findUserByEmail(e){let[n]=await m.select().from(b).where(g(b.email,e));return n?_(n):null}async findUserById(e){let n=I(e),[o]=await m.select().from(b).where(g(b.id,n));return o?_(o):null}async findUserByVerificationToken(e){let[n]=await m.select().from(b).where(g(b.verificationToken,e));return n?_(n):null}async updateUser(e,n){let o=I(e),a={};return n.firstName!==void 0&&(a.firstName=n.firstName),n.lastName!==void 0&&(a.lastName=n.lastName),n.email!==void 0&&(a.email=n.email),n.phone!==void 0&&(a.phone=n.phone),n.phoneVerified!==void 0&&(a.phoneVerified=n.phoneVerified),n.phoneVerificationCode!==void 0&&(a.phoneVerificationCode=n.phoneVerificationCode||null),n.phoneVerificationExpiry!==void 0&&(a.phoneVerificationExpiry=n.phoneVerificationExpiry||null),n.role!==void 0&&(a.role=n.role),n.isLive!==void 0&&(a.isLive=n.isLive),n.emailVerified!==void 0&&(a.emailVerified=n.emailVerified),n.verificationToken!==void 0&&(a.verificationToken=n.verificationToken||null),n.verificationTokenExpiry!==void 0&&(a.verificationTokenExpiry=n.verificationTokenExpiry||null),n.driverDetails!==void 0&&(a.driverDetails=n.driverDetails),n.kycStatus!==void 0&&(a.kycStatus=n.kycStatus),n.kycSubmittedAt!==void 0&&(a.kycSubmittedAt=n.kycSubmittedAt),n.kycReviewedAt!==void 0&&(a.kycReviewedAt=n.kycReviewedAt),n.kycReviewedBy!==void 0&&(a.kycReviewedBy=n.kycReviewedBy),n.kycRejectionReason!==void 0&&(a.kycRejectionReason=n.kycRejectionReason),n.licenseDocumentUrl!==void 0&&(a.licenseDocumentUrl=n.licenseDocumentUrl),n.accountStatus!==void 0&&(a.accountStatus=n.accountStatus),n.suspensionReason!==void 0&&(a.suspensionReason=n.suspensionReason),n.password!==void 0&&(a.password=n.password),n.staffType!==void 0&&(a.staffType=n.staffType),a.updatedAt=new Date,await m.update(b).set(a).where(g(b.id,o)),this.findUserById(o)}async getAllUsers(e){let n=e?.page||1,o=e?.limit||20,a=(n-1)*o,i=[];e?.role&&e.role!=="all"&&i.push(g(b.role,e.role)),e?.search&&i.push(ae(K(b.email,`%${e.search}%`),K(b.firstName,`%${e.search}%`),K(b.lastName,`%${e.search}%`)));let r=i.length>0?$(...i):void 0,[s,t]=await Promise.all([r?m.select().from(b).where(r).orderBy(te(b.createdAt)).limit(o).offset(a):m.select().from(b).orderBy(te(b.createdAt)).limit(o).offset(a),r?m.select({cnt:se()}).from(b).where(r):m.select({cnt:se()}).from(b)]),c=t[0]?.cnt||0;return{users:s.map(_),total:c}}async updateUserStatus(e,n,o){let a=I(e),i={accountStatus:n,updatedAt:new Date};return o&&(i.suspensionReason=o),await m.update(b).set(i).where(g(b.id,a)),this.findUserById(a)}async getPendingKYCDrivers(){return(await m.select().from(b).where($(g(b.role,"driver"),g(b.kycStatus,"pending"))).orderBy(De(b.kycSubmittedAt))).map(_)}async approveDriverKYC(e,n){let o=I(e);return await m.update(b).set({kycStatus:"approved",kycReviewedAt:new Date,kycReviewedBy:n,updatedAt:new Date}).where($(g(b.id,o),g(b.role,"driver"))),this.findUserById(o)}async rejectDriverKYC(e,n,o){let a=I(e);return await m.update(b).set({kycStatus:"rejected",kycReviewedAt:new Date,kycReviewedBy:n,kycRejectionReason:o,updatedAt:new Date}).where($(g(b.id,a),g(b.role,"driver"))),this.findUserById(a)}async getAdminStats(){let[e,n,o,a,i,r,s]=await Promise.all([m.select({cnt:se()}).from(b),m.select({cnt:se()}).from(b).where(g(b.role,"driver")),m.select({cnt:se()}).from(b).where(g(b.role,"passenger")),m.select({cnt:se()}).from(b).where($(g(b.role,"driver"),g(b.kycStatus,"pending"))),m.select({cnt:se()}).from(S),m.select({cnt:se()}).from(C).where(ae(g(C.status,"open"),g(C.status,"in_progress"))),m.select({total:L`COALESCE(SUM(CAST(${S.price} AS DECIMAL(10,2))), 0)`}).from(S).where(ae(g(S.status,"confirmed"),g(S.status,"completed")))]);return{totalUsers:e[0]?.cnt||0,totalDrivers:n[0]?.cnt||0,totalPassengers:o[0]?.cnt||0,pendingKYC:a[0]?.cnt||0,totalBookings:i[0]?.cnt||0,totalRevenue:s[0]?.total||0,openTickets:r[0]?.cnt||0}}async createSupportTicket(e){let n=e.userId||e.odId,[o]=await m.insert(C).values({userId:I(n),userEmail:e.userEmail,userName:e.userName,subject:e.subject,message:e.message,status:e.status||"open",priority:e.priority||"medium",category:e.category||"other"}),a=o.insertId;return{_id:a,id:a,userId:I(n),userEmail:e.userEmail,userName:e.userName,subject:e.subject,message:e.message,status:e.status||"open",priority:e.priority||"medium",category:e.category||"other",createdAt:new Date,updatedAt:new Date}}async getUserSupportTickets(e){let n=I(e);return(await m.select().from(C).where(g(C.userId,n)).orderBy(te(C.createdAt))).map(_)}async getAllSupportTickets(e){let n=[];e?.status&&e.status!=="all"&&n.push(g(C.status,e.status)),e?.priority&&e.priority!=="all"&&n.push(g(C.priority,e.priority));let o=n.length>0?$(...n):void 0;return(o?await m.select().from(C).where(o).orderBy(te(C.createdAt)):await m.select().from(C).orderBy(te(C.createdAt))).map(_)}async updateSupportTicket(e,n){let o=I(e),a={updatedAt:new Date};n.status!==void 0&&(a.status=n.status),n.priority!==void 0&&(a.priority=n.priority),n.adminNotes!==void 0&&(a.adminNotes=n.adminNotes),n.assignedTo!==void 0&&(a.assignedTo=n.assignedTo),n.resolvedAt!==void 0&&(a.resolvedAt=n.resolvedAt),await m.update(C).set(a).where(g(C.id,o));let[i]=await m.select().from(C).where(g(C.id,o));return i?_(i):null}async updateSchedulesByDriverId(e,n){let o={};n.isLive!==void 0&&(o.isLive=n.isLive),n.startLocation!==void 0&&(o.startLocation=n.startLocation),n.endLocation!==void 0&&(o.endLocation=n.endLocation);let[a]=await m.update(f).set(o).where(g(f.driverId,e));return a.affectedRows||0}async findScheduleWithOwnership(e,n){let o=I(e),a=I(n),[i]=await m.select().from(f).where($(g(f.id,o),g(f.driverId,a)));return i?{..._(i),route:i.routeData,price:i.price?parseFloat(String(i.price)):0}:null}async updateSchedule(e,n){let o=I(e),a={};if(n.departureTime!==void 0&&(a.departureTime=n.departureTime instanceof Date?n.departureTime:new Date(n.departureTime)),n.price!==void 0&&(a.price=n.price.toString()),n.capacity!==void 0&&(a.capacity=n.capacity),n.availableSeats!==void 0&&(a.availableSeats=n.availableSeats),n.isLive!==void 0&&(a.isLive=n.isLive),n.startLocation!==void 0&&(a.startLocation=n.startLocation),n.endLocation!==void 0&&(a.endLocation=n.endLocation),n.routeData!==void 0&&(a.routeData=n.routeData),n.fareBreakdown!==void 0&&(a.fareBreakdown=n.fareBreakdown),n.stopsData!==void 0&&(a.stopsData=n.stopsData),n["route.startLocation"]||n["route.endLocation"]){let[i]=await m.select().from(f).where(g(f.id,o));if(i){let r=i.routeData||{};n["route.startLocation"]&&(r.startLocation=n["route.startLocation"]),n["route.endLocation"]&&(r.endLocation=n["route.endLocation"]),a.routeData=r,n["route.startLocation"]&&(a.startLocation=n["route.startLocation"]),n["route.endLocation"]&&(a.endLocation=n["route.endLocation"])}}return Object.keys(a).length===0?this.getSchedule(o):(await m.update(f).set(a).where(g(f.id,o)),this.getSchedule(o))}async toggleScheduleLive(e,n,o){let a=I(e),i=I(n);await m.update(f).set({isLive:!!o}).where($(g(f.id,a),g(f.driverId,i)));let[r]=await m.select().from(f).where($(g(f.id,a),g(f.driverId,i)));return r?{..._(r),route:r.routeData,price:r.price?parseFloat(String(r.price)):0}:null}async getBookingsBySchedule(e,n){let o=I(e),a=[g(S.scheduleId,o)];return n&&a.push(g(S.status,n)),(await m.select().from(S).where($(...a))).map(_)}async atomicDecrementSeats(e,n){let o=I(e);return m.transaction(async a=>{let[i]=await a.select().from(f).where(g(f.id,o)).for("update");if(!i||!i.availableSeats||i.availableSeats<n)throw new Error(`Not enough seats available. Have ${i?.availableSeats||0}, need ${n}`);await a.update(f).set({availableSeats:L`${f.availableSeats} - ${n}`}).where(g(f.id,o));let[r]=await a.select().from(f).where(g(f.id,o));return r?_(r):null})}async insertBookingDirect(e){let n=I(e.userId),o=I(e.scheduleId),[a]=await m.insert(S).values({userId:n,scheduleId:o,seatNumber:e.seatNumber||null,pickup:e.pickup||null,dropoff:e.dropoff||null,price:e.price?.toString()||"0",status:e.status||"confirmed",isGroupBooking:e.isGroupBooking||!1,numberOfSeats:e.numberOfSeats||null,organizationName:e.organizationName||null,organizationType:e.organizationType||null,contactName:e.contactName||null,contactPhone:e.contactPhone||null,notes:e.notes||null,rideRequestId:e.rideRequestId?I(e.rideRequestId):null}),i=a.insertId;return{_id:i,id:i,...e,userId:n,scheduleId:o}}async updateBookingStatus(e,n){let o=I(e);await m.update(S).set({status:n}).where(g(S.id,o));let[a]=await m.select().from(S).where(g(S.id,o));return a?_(a):null}async getDemandAnalytics(){return(await m.select({startLocation:f.startLocation,endLocation:f.endLocation,bookingCount:L`COUNT(*)`,totalRevenue:L`COALESCE(SUM(CAST(${f.price} AS DECIMAL(10,2))), 0)`}).from(S).innerJoin(f,g(S.scheduleId,f.id)).where(ae(g(S.status,"confirmed"),g(S.status,"completed"))).groupBy(f.startLocation,f.endLocation).orderBy(L`COUNT(*) DESC`).limit(20)).map(n=>({startLocation:n.startLocation,endLocation:n.endLocation,bookingCount:n.bookingCount,totalRevenue:n.totalRevenue}))}async getPeakHoursAnalytics(){let e=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];return(await m.select({hour:L`HOUR(${f.departureTime})`,dayOfWeek:L`DAYOFWEEK(${f.departureTime})`,bookingCount:L`COUNT(*)`}).from(S).innerJoin(f,g(S.scheduleId,f.id)).where(ae(g(S.status,"confirmed"),g(S.status,"completed"))).groupBy(L`HOUR(${f.departureTime})`,L`DAYOFWEEK(${f.departureTime})`).orderBy(L`DAYOFWEEK(${f.departureTime})`,L`HOUR(${f.departureTime})`)).map(o=>({hour:o.hour,dayOfWeek:o.dayOfWeek,dayName:e[(o.dayOfWeek||1)-1]||"Unknown",bookingCount:o.bookingCount}))}async getRevenueAnalytics(e,n){let o=n||new Date(Date.now()-2592e6),a=[ae(g(S.status,"confirmed"),g(S.status,"completed")),Je(S.createdAt,o)];e&&a.push(g(f.driverId,e));let i=$(...a),r=await m.select({date:L`DATE_FORMAT(${S.createdAt}, '%Y-%m-%d')`,bookingCount:L`COUNT(*)`,revenue:L`COALESCE(SUM(CAST(${f.price} AS DECIMAL(10,2))), 0)`}).from(S).innerJoin(f,g(S.scheduleId,f.id)).where(i).groupBy(L`DATE_FORMAT(${S.createdAt}, '%Y-%m-%d')`).orderBy(L`DATE_FORMAT(${S.createdAt}, '%Y-%m-%d')`),s=await m.select({totalBookings:L`COUNT(*)`,totalRevenue:L`COALESCE(SUM(CAST(${f.price} AS DECIMAL(10,2))), 0)`,avgRevenue:L`COALESCE(AVG(CAST(${f.price} AS DECIMAL(10,2))), 0)`}).from(S).innerJoin(f,g(S.scheduleId,f.id)).where(i),t=await m.select({startLocation:f.startLocation,endLocation:f.endLocation,bookingCount:L`COUNT(*)`,revenue:L`COALESCE(SUM(CAST(${f.price} AS DECIMAL(10,2))), 0)`}).from(S).innerJoin(f,g(S.scheduleId,f.id)).where(i).groupBy(f.startLocation,f.endLocation).orderBy(L`COALESCE(SUM(CAST(${f.price} AS DECIMAL(10,2))), 0) DESC`).limit(5);return{dailyRevenue:r.map(c=>({date:c.date,bookings:c.bookingCount,revenue:c.revenue||0})),summary:s[0]||{totalBookings:0,totalRevenue:0,avgRevenue:0},popularRoutes:t.map(c=>({route:`${c.startLocation} \u2192 ${c.endLocation}`,bookings:c.bookingCount,revenue:c.revenue||0}))}}async createReport(e){let[n]=await m.insert(le).values({userId:I(e.userId),type:e.type,scheduleId:e.scheduleId?I(e.scheduleId):null,routeId:e.routeId?I(e.routeId):null,details:e.details||null,locationLat:e.location?.lat?.toString()||e.locationLat?.toString()||null,locationLng:e.location?.lng?.toString()||e.locationLng?.toString()||null,status:e.status||"pending"}),o=n.insertId;return{_id:o,id:o,...e}}async getRouteReports(e,n){let o=I(e);return(await m.select().from(le).where($(g(le.routeId,o),Je(le.createdAt,n))).orderBy(te(le.createdAt)).limit(10)).map(_)}async createSOSAlert(e){let[n]=await m.insert(Ke).values({userId:I(e.userId),scheduleId:e.scheduleId?I(e.scheduleId):null,locationLat:e.location?.lat?.toString()||e.locationLat?.toString()||null,locationLng:e.location?.lng?.toString()||e.locationLng?.toString()||null,message:e.message||"Emergency alert",status:e.status||"active"}),o=n.insertId;return{_id:o,id:o,...e}}async findLiveSchedulesForRoute(e,n){return(await m.select().from(f).where(g(f.isLive,!0))).filter(a=>{let i=(a.startLocation||"").toLowerCase(),r=(a.endLocation||"").toLowerCase(),s=a.stopsData;if(typeof s=="string")try{s=JSON.parse(s)}catch{s=[]}s=(Array.isArray(s)?s:[])||[];let t=a.routeData;if(typeof t=="string")try{t=JSON.parse(t)}catch{t=null}let c=(t?.startLocation||"").toLowerCase(),u=(t?.endLocation||"").toLowerCase(),d=[i,r,c,u,...s.map(A=>(typeof A=="string"?A:A?.name||"").toLowerCase())],p=e.toLowerCase(),v=n.toLowerCase(),y=d.some(A=>A.includes(p)),N=d.some(A=>A.includes(v));return y||N}).map(_)}async findLiveDriversByIds(e){return e.length===0?[]:(await m.select({id:b.id,firstName:b.firstName,lastName:b.lastName}).from(b).where($(Zt(b.id,e),g(b.role,"driver"),g(b.isLive,!0)))).map(o=>({...o,_id:o.id}))}async createRideRequest(e){let[n]=await m.insert(G).values({userId:I(e.userId),userName:e.userName||null,userPhone:e.userPhone||null,fromLocation:e.from||e.fromLocation,toLocation:e.to||e.toLocation,seats:e.seats||1,departureTime:e.departureTime?new Date(e.departureTime):null,notes:e.notes||null,status:e.status||"pending",estimatedFare:e.estimatedFare?.toString()||null,estimatedDistance:e.estimatedDistance?.toString()||null,notifiedDrivers:e.notifiedDrivers||null}),o=n.insertId;return{_id:o,id:o,...e}}async getRecentRideRequests(){let e=new Date(Date.now()-864e5);return(await m.select().from(G).where($(g(G.status,"pending"),Je(G.createdAt,e))).orderBy(te(G.createdAt)).limit(50)).map(o=>({..._(o),from:o.fromLocation,to:o.toLocation,estimatedFare:o.estimatedFare?parseFloat(String(o.estimatedFare)):0,estimatedDistance:o.estimatedDistance?parseFloat(String(o.estimatedDistance)):0}))}async findRideRequest(e,n){let o=I(e),a=[g(G.id,o)];n?.status&&a.push(g(G.status,n.status)),n?.userId&&a.push(g(G.userId,I(n.userId)));let[i]=await m.select().from(G).where($(...a));return i?{..._(i),from:i.fromLocation,to:i.toLocation,estimatedFare:i.estimatedFare?parseFloat(String(i.estimatedFare)):0,estimatedDistance:i.estimatedDistance?parseFloat(String(i.estimatedDistance)):0}:null}async updateRideRequest(e,n){let o=I(e),a={};return n.status!==void 0&&(a.status=n.status),n.acceptedBy!==void 0&&(a.acceptedBy=n.acceptedBy?I(n.acceptedBy):null),n.acceptedByName!==void 0&&(a.acceptedByName=n.acceptedByName),n.acceptedScheduleId!==void 0&&(a.acceptedScheduleId=n.acceptedScheduleId?I(n.acceptedScheduleId):null),n.acceptedAt!==void 0&&(a.acceptedAt=n.acceptedAt),n.cancelledAt!==void 0&&(a.cancelledAt=n.cancelledAt),n.notifiedDrivers!==void 0&&(a.notifiedDrivers=n.notifiedDrivers),Object.keys(a).length===0?this.findRideRequest(o):(await m.update(G).set(a).where(g(G.id,o)),this.findRideRequest(o))}async deleteUser(e){let n=I(e),[o]=await m.delete(b).where(g(b.id,n));return o.affectedRows>0}async createStaffUser(e){let n=await ft.hash(e.password,10),[o]=await m.insert(b).values({email:e.email,password:n,firstName:e.firstName,lastName:e.lastName,role:"admin",staffType:e.staffType||"station_master",accountStatus:"active",emailVerified:!0}),a=o.insertId;return{_id:a,id:a,email:e.email,firstName:e.firstName,lastName:e.lastName,role:"admin",staffType:e.staffType||"station_master"}}},h=new Le});var At={};_e(At,{geocodeAddress:()=>xe,searchMaps:()=>$e});import ds from"axios";async function $e(l){if(!Pt)throw new Error("MAPBOX_ACCESS_TOKEN is not set");let e=l.toLowerCase().includes("ghana")?l:`${l}, Ghana`,n=encodeURIComponent(e),o=`${ms}/${n}.json`;return(await ds.get(o,{params:{access_token:Pt,country:"gh",limit:10,types:"place,locality,neighborhood,address,poi",language:"en"}})).data.features.map(i=>({title:i.text,address:i.place_name,type:i.place_type[0]||"place",coordinates:{lng:i.center[0],lat:i.center[1]}}))}async function xe(l){let e=await $e(l);return e.length>0&&e[0].coordinates?e[0].coordinates:null}var ms,Pt,Ue=me(()=>{"use strict";ms="https://api.mapbox.com/geocoding/v5/mapbox.places",Pt=process.env.MAPBOX_ACCESS_TOKEN});import{defineConfig as vs}from"vite";import ws from"@vitejs/plugin-react";import ie from"path";import{fileURLToPath as Is}from"url";var ue,xt,Ut=me(()=>{"use strict";ue=ie.dirname(Is(import.meta.url)),xt=vs({plugins:[ws()],root:ie.resolve(ue,"client"),publicDir:ie.resolve(ue,"public"),envDir:ie.resolve(ue),resolve:{alias:{"@":ie.resolve(ue,"client","src"),"/src":ie.resolve(ue,"client","src"),"@shared":ie.resolve(ue,"shared"),"@assets":ie.resolve(ue,"attached_assets")}},build:{outDir:ie.resolve(ue,"dist"),emptyOutDir:!0,chunkSizeWarningLimit:1800,rollupOptions:{output:{manualChunks(l){if(l.includes("node_modules")){if(l.includes("react")||l.includes("react-dom")||l.includes("framer-motion")||l.includes("wouter"))return"vendor";if(l.includes("@radix-ui"))return"ui";if(l.includes("recharts")||l.includes("d3-"))return"charts";if(l.includes("mapbox-gl"))return"mapbox"}}}}},server:{proxy:{"/api":{target:"http://0.0.0.0:5000",changeOrigin:!0,secure:!1},"/ws":{target:"http://0.0.0.0:5000",ws:!0}},allowedHosts:["makewego.unusualbeautymodel.com"],fs:{strict:!0,deny:["**/.*"]}}})});var Bt={};_e(Bt,{setupVite:()=>_s});import{createServer as Ns,createLogger as Ts}from"vite";import Ps from"fs";import at from"path";import{fileURLToPath as As}from"url";async function _s(l,e){let n=await Ns({...xt,configFile:!1,server:{middlewareMode:!0,hmr:{server:l,clientPort:5e3}},appType:"custom"});e.use(n.middlewares),e.use(async(o,a,i)=>{let r=o.originalUrl;try{let s=at.extname(r);if(s&&s!==".html")return i();let t=at.resolve(process.cwd(),"client","index.html"),c=await Ps.promises.readFile(t,"utf-8"),u=await n.transformIndexHtml(r,c);a.status(200).set({"Content-Type":"text/html"}).end(u)}catch(s){n.ssrFixStacktrace(s),i(s)}})}var un,ln,Ot=me(()=>{"use strict";Ut();un=at.dirname(As(import.meta.url)),ln=Ts()});import ut from"dotenv";import lt from"path";import{fileURLToPath as Kt}from"url";import Wt from"fs";var Gt=Kt(import.meta.url),Ht=lt.dirname(Gt),Ee=lt.resolve(Ht,"../.env");Wt.existsSync(Ee)?(console.log(`[Env] Loading variables from: ${Ee}`),ut.config({path:Ee})):(console.warn(`[Env] Warning: .env file not found at ${Ee}`),ut.config());process.env.NODE_ENV=process.env.NODE_ENV||"development";process.env.PORT=process.env.PORT||"5000";console.log(`[Env] SMTP_HOST: ${process.env.SMTP_HOST||"NOT SET"}`);console.log(`[Env] SMTP_USER: ${process.env.SMTP_USER||"NOT SET"}`);console.log(`[Env] SMTP_PASS: ${process.env.SMTP_PASS?`SET (${process.env.SMTP_PASS.length} chars)`:"NOT SET"}`);if(process.env.SMTP_HOST==="smtp.gmail.com"&&process.env.SMTP_PASS){let l=process.env.SMTP_PASS.replace(/\s/g,"");l.length!==16&&console.warn(`[Env] WARNING: Gmail App Password should be 16 characters, got ${l.length}`),process.env.SMTP_PASS=l}import it from"express";import Ft from"path";import Mt from"fs";import{setServers as Es}from"dns";import{createServer as Rs}from"http";qe();import{Router as os}from"express";import as from"bcrypt";import St from"jsonwebtoken";import gt from"nodemailer";import es from"crypto";function Qe(){return{host:process.env.SMTP_HOST||"smtp.gmail.com",port:parseInt(process.env.SMTP_PORT||"587"),user:process.env.SMTP_USER||"",pass:process.env.SMTP_PASS||"",appUrl:process.env.APP_URL||"https://makewego.unusualbeautymodel.com",appName:process.env.APP_NAME||"BusConnect"}}function yt(){let l=Qe();return console.log(`[Email] Creating transporter - host: ${l.host}, port: ${l.port}, user: ${l.user?l.user.substring(0,5)+"***":"NOT SET"}`),l.host==="smtp.gmail.com"?(console.log("[Email] Using Gmail service configuration"),gt.createTransport({service:"gmail",auth:{user:l.user,pass:l.pass}})):gt.createTransport({host:l.host,port:l.port,secure:l.port===465,auth:{user:l.user,pass:l.pass}})}function ve(){return es.randomBytes(32).toString("hex")}function Xe(){return new Date(Date.now()+1440*60*1e3)}async function we(l,e,n){let o=Qe(),a=`${o.appUrl}/verify-email?token=${n}`;console.log(`[Email] Attempting to send verification email to: ${l}`),console.log(`[Email] SMTP User configured: ${o.user?"YES ("+o.user+")":"NO"}`),console.log(`[Email] SMTP Pass configured: ${o.pass?"YES":"NO"}`);let i={from:`"${o.appName}" <${o.user}>`,to:l,subject:`Verify your ${o.appName} account`,html:`
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Verify Your Email</title>
      </head>
      <body style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; line-height: 1.6; margin: 0; padding: 0; background-color: #f4f7fa;">
        <div style="max-width: 600px; margin: 0 auto; padding: 40px 20px;">
          <div style="background: linear-gradient(135deg, #2563eb 0%, #4f46e5 100%); padding: 40px 30px; text-align: center; border-radius: 16px 16px 0 0;">
            <h1 style="color: white; margin: 0; font-size: 28px; font-weight: 700;">${o.appName}</h1>
            <p style="color: rgba(255,255,255,0.9); margin: 10px 0 0 0; font-size: 16px;">Email Verification</p>
          </div>

          <div style="background: white; padding: 40px 30px; border-radius: 0 0 16px 16px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
            <h2 style="color: #1e293b; margin: 0 0 20px 0; font-size: 24px;">Hello ${e}!</h2>

            <p style="color: #475569; margin: 0 0 20px 0; font-size: 16px;">
              Thank you for signing up for ${o.appName}. To complete your registration and start using your account, please verify your email address by clicking the button below.
            </p>

            <div style="text-align: center; margin: 30px 0;">
              <a href="${a}" style="display: inline-block; background: linear-gradient(135deg, #2563eb 0%, #4f46e5 100%); color: white; text-decoration: none; padding: 16px 40px; border-radius: 8px; font-weight: 600; font-size: 16px;">
                Verify Email Address
              </a>
            </div>

            <p style="color: #64748b; margin: 20px 0 0 0; font-size: 14px;">
              This link will expire in 24 hours. If you didn't create an account with ${o.appName}, you can safely ignore this email.
            </p>

            <hr style="border: none; border-top: 1px solid #e2e8f0; margin: 30px 0;">

            <p style="color: #94a3b8; margin: 0; font-size: 12px; text-align: center;">
              If the button above doesn't work, copy and paste this link into your browser:<br>
              <a href="${a}" style="color: #2563eb; word-break: break-all;">${a}</a>
            </p>
          </div>

          <p style="color: #94a3b8; font-size: 12px; text-align: center; margin: 20px 0 0 0;">
            &copy; ${new Date().getFullYear()} ${o.appName}. All rights reserved.
          </p>
        </div>
      </body>
      </html>
    `,text:`
Hello ${e}!

Thank you for signing up for ${o.appName}. To complete your registration, please verify your email address by visiting the link below:

${a}

This link will expire in 24 hours.

If you didn't create an account with ${o.appName}, you can safely ignore this email.

- The ${o.appName} Team
    `};try{if(!o.user||!o.pass)return console.warn("[Email] SMTP credentials not configured. Skipping email send."),console.log("[Email] Verification URL (for testing):",a),!0;let s=await yt().sendMail(i);return console.log(`[Email] SUCCESS: Verification email sent to ${l}`),console.log(`[Email] Message ID: ${s.messageId}`),!0}catch(r){return console.error(`[Email] FAILED to send verification email to ${l}:`,r.message),console.error("[Email] Full error details:",r),!1}}async function ht(){let l=Qe();console.log(`[Email] Testing connection - host: ${l.host}, user: ${l.user||"NOT SET"}`);try{return!l.user||!l.pass?(console.warn("[Email] SMTP credentials not configured"),!1):(await yt().verify(),console.log("[Email] SMTP connection verified successfully!"),!0)}catch(e){return console.error("[Email] SMTP connection failed:",e.message),!1}}import{parsePhoneNumber as Ze,isValidPhoneNumber as ts}from"libphonenumber-js";function et(){return Math.floor(1e5+Math.random()*9e5).toString()}function tt(){let l=new Date;return l.setMinutes(l.getMinutes()+15),l}function st(l){if(!l)return{valid:!1,error:"Phone number is required"};try{if(!ts(l))return{valid:!1,error:"Please enter a valid phone number with country code"};let e=Ze(l);return e?{valid:!0,formatted:e.format("E.164")}:{valid:!1,error:"Could not parse phone number"}}catch{return{valid:!1,error:"Invalid phone number format"}}}function je(l){try{if(l.startsWith("+")){let n=Ze(l);if(n)return n.format("E.164")}let e=l.replace(/\D/g,"");return e.startsWith("0")?e="233"+e.slice(1):!e.startsWith("233")&&e.length<=10&&(e="233"+e),"+"+e}catch{return l.startsWith("+")?l:"+"+l.replace(/\D/g,"")}}function bt(l){try{let e=Ze(l);return e?e.formatInternational():l}catch{return l}}async function rt(l,e){let n=je(l),o=`MoGo verification code: ${e}. Valid for 15 minutes. Do not share this code with anyone.`,a=process.env.SMS_PROVIDER||"log";console.log(`[SMS] Sending verification to ${n} via ${a}`);try{switch(a){case"twilio":return await ss(n,o);case"arkesel":return await rs(n,o);case"hubtel":return await ns(n,o);case"log":default:return console.log(`[SMS DEV] Verification code for ${n}: ${e}`),!0}}catch(i){return console.error("[SMS] Failed to send verification:",i),!1}}async function ss(l,e){let n=process.env.TWILIO_ACCOUNT_SID,o=process.env.TWILIO_AUTH_TOKEN,a=process.env.TWILIO_PHONE_NUMBER;if(!n||!o||!a)return console.error("[SMS] Twilio credentials not configured"),!1;let i=await fetch(`https://api.twilio.com/2010-04-01/Accounts/${n}/Messages.json`,{method:"POST",headers:{Authorization:"Basic "+Buffer.from(`${n}:${o}`).toString("base64"),"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({To:l,From:a,Body:e})});if(!i.ok){let r=await i.text();return console.error("[SMS Twilio] Error:",r),!1}return!0}async function rs(l,e){let n=process.env.ARKESEL_API_KEY,o=process.env.ARKESEL_SENDER_ID||"MoGo";if(!n)return console.error("[SMS] Arkesel API key not configured"),!1;let a=await fetch("https://sms.arkesel.com/api/v2/sms/send",{method:"POST",headers:{"api-key":n,"Content-Type":"application/json"},body:JSON.stringify({sender:o,message:e,recipients:[l.replace("+","")]})});if(!a.ok){let i=await a.text();return console.error("[SMS Arkesel] Error:",i),!1}return!0}async function ns(l,e){let n=process.env.HUBTEL_CLIENT_ID,o=process.env.HUBTEL_CLIENT_SECRET,a=process.env.HUBTEL_SENDER_ID||"MoGo";if(!n||!o)return console.error("[SMS] Hubtel credentials not configured"),!1;let i=l.replace("+",""),r=new URL("https://smsc.hubtel.com/v1/messages/send");r.searchParams.append("clientid",n),r.searchParams.append("clientsecret",o),r.searchParams.append("from",a),r.searchParams.append("to",i),r.searchParams.append("content",e),console.log(`[SMS Hubtel] Sending to ${i} from ${a}`),console.log(`[SMS Hubtel] Message content: ${e}`),console.log(`[SMS Hubtel] Full URL: ${r.toString()}`);try{let s=await fetch(r.toString(),{method:"GET"}),t=await s.json();return console.log("[SMS Hubtel] Response:",JSON.stringify(t)),!s.ok||t.status!==0?(console.error("[SMS Hubtel] Error:",t),!1):(console.log(`[SMS Hubtel] Message sent successfully, ID: ${t.messageId}`),!0)}catch(s){return console.error("[SMS Hubtel] Exception:",s),!1}}var vt=process.env.JWT_SECRET||"your-secret-key";console.log("[Auth] JWT_SECRET loaded:",process.env.JWT_SECRET?"YES":"NO");console.log("[Auth] APP_URL for verification:",process.env.APP_URL||"NOT SET");console.log("[Auth] NODE_ENV:",process.env.NODE_ENV||"development");function wt(l){let e=os();function n(o,a,i){console.log(`[AUTH] Authenticating ${o.method} ${o.path}`);let r=o.headers.authorization,s=r&&r.split(" ")[1];if(!s)return a.status(401).json({message:"Access token required"});St.verify(s,vt,(t,c)=>{if(t)return a.status(403).json({message:"Invalid or expired token"});o.user=c,i()})}return e.post("/register",async(o,a)=>{try{let{email:i,password:r,firstName:s,lastName:t,phone:c,role:u,driverDetails:d}=o.body;if(!i||!r||!s||!t||!u)return a.status(400).json({message:"All fields are required"});if(!["passenger","driver"].includes(u))return a.status(400).json({message:"Invalid role"});if(u==="driver"&&(!d||!d.licenseNumber||!d.vehicleParams||!d.vehicleParams.make||!d.vehicleParams.model||!d.vehicleParams.plateNumber||!d.vehicleParams.capacity))return a.status(400).json({message:"Driver details and vehicle information are required for drivers"});if(await l.findUserByEmail(i))return a.status(409).json({message:"User already exists"});let v=ve(),y=Xe(),N=await l.createUser({email:i,password:r,firstName:s,lastName:t,phone:c||"",role:u,driverDetails:u==="driver"?d:void 0,emailVerified:!1,verificationToken:v,verificationTokenExpiry:y});await we(i,s,v),a.status(201).json({message:"Registration successful. Please check your email to verify your account.",requiresVerification:!0,user:{_id:N._id,email:N.email,firstName:N.firstName,lastName:N.lastName,role:N.role,emailVerified:!1}})}catch(i){console.error("Registration error:",i),a.status(500).json({message:"Internal server error"})}}),e.post("/login",async(o,a)=>{try{let{email:i,password:r}=o.body;if(!i||!r)return a.status(400).json({message:"Email and password are required"});let s=await l.findUserByEmail(i);if(!s)return console.warn(`[Login] Failure: User not found (${i})`),a.status(401).json({message:"Invalid credentials"});if(!await as.compare(r,s.password))return console.warn(`[Login] Failure: Invalid password for ${i}`),a.status(401).json({message:"Invalid credentials"});if(!s.emailVerified)return console.warn(`[Login] Failure: Email not verified for ${i}`),a.status(403).json({message:"Please verify your email before logging in",requiresVerification:!0,email:s.email});let c=St.sign({_id:s._id,email:s.email,phone:s.phone||"",firstName:s.firstName,lastName:s.lastName,role:s.role},vt,{expiresIn:"7d"});a.json({user:{_id:s._id,email:s.email,phone:s.phone||"",phoneVerified:s.phoneVerified||!1,firstName:s.firstName,lastName:s.lastName,role:s.role,emailVerified:!0},token:c})}catch(i){console.error("Login error:",i),a.status(500).json({message:"Internal server error"})}}),e.get("/user",n,async(o,a)=>{try{let i=o.user;if(!i||!i._id)return a.status(401).json({message:"Not authenticated"});let r=await l.findUserById(String(i._id));if(!r)return a.status(404).json({message:"User not found"});a.json({_id:r._id,email:r.email,phone:r.phone||"",phoneVerified:r.phoneVerified||!1,firstName:r.firstName,lastName:r.lastName,role:r.role,driverDetails:r.driverDetails,isLive:r.isLive||!1})}catch(i){console.error("Get user error:",i),a.status(500).json({message:"Internal server error"})}}),e.post("/logout",(o,a)=>{a.json({message:"Logged out successfully"})}),e.get("/verify-email",async(o,a)=>{try{let{token:i}=o.query;if(!i||typeof i!="string")return a.status(400).json({message:"Verification token is required"});let r=await l.findUserByVerificationToken(i);if(!r)return a.status(400).json({message:"Invalid or expired verification token"});if(r.verificationTokenExpiry&&new Date>new Date(r.verificationTokenExpiry))return a.status(400).json({message:"Verification token has expired. Please request a new one."});if(r.emailVerified)return a.json({message:"Email already verified",alreadyVerified:!0});await l.updateUser(String(r._id),{emailVerified:!0,verificationToken:void 0,verificationTokenExpiry:void 0}),a.json({message:"Email verified successfully",verified:!0})}catch(i){console.error("Email verification error:",i),a.status(500).json({message:"Internal server error"})}}),e.post("/resend-verification",async(o,a)=>{try{let{email:i}=o.body;if(!i)return a.status(400).json({message:"Email is required"});let r=await l.findUserByEmail(i);if(!r)return a.json({message:"If your email is registered, you will receive a verification email."});if(r.emailVerified)return a.status(400).json({message:"Email is already verified"});let s=ve(),t=Xe();await l.updateUser(String(r._id),{verificationToken:s,verificationTokenExpiry:t}),await we(i,r.firstName,s),a.json({message:"Verification email sent. Please check your inbox."})}catch(i){console.error("Resend verification error:",i),a.status(500).json({message:"Internal server error"})}}),e.post("/send-phone-verification",n,async(o,a)=>{try{let i=o.user?._id;if(!i)return a.status(401).json({message:"Not authenticated"});let{phone:r}=o.body;if(!r)return a.status(400).json({message:"Phone number is required"});let s=st(r);if(!s.valid)return a.status(400).json({message:s.error||"Invalid phone number"});let t=s.formatted||je(r);console.log(`[Auth] Phone verification requested for: ${t}`),console.log("[Auth] Using SMS provider for phone verification");let c=et(),u=tt();if(await l.updateUser(String(i),{phone:t,phoneVerificationCode:c,phoneVerificationExpiry:u,phoneVerified:!1}),!await rt(t,c))return a.status(500).json({message:"Failed to send verification SMS. Please try again."});a.json({message:`Verification code sent to ${bt(t)}`,phone:t,provider:"sms"})}catch(i){console.error("Send phone verification error:",i),a.status(500).json({message:"Internal server error"})}}),e.post("/verify-phone",n,async(o,a)=>{try{let i=o.user?._id;if(!i)return a.status(401).json({message:"Not authenticated"});let{code:r}=o.body;if(!r)return a.status(400).json({message:"Verification code is required"});let s=await l.findUserById(String(i));if(!s)return a.status(404).json({message:"User not found"});if(s.phoneVerified)return a.json({message:"Phone already verified",alreadyVerified:!0});if(!s.phone)return a.status(400).json({message:"No phone number to verify. Please request a verification code first."});if(console.log("[Auth] Verifying code locally"),s.phoneVerificationCode!==r)return a.status(400).json({message:"Invalid verification code"});if(s.phoneVerificationExpiry&&new Date>new Date(s.phoneVerificationExpiry))return a.status(400).json({message:"Verification code has expired. Please request a new one."});await l.updateUser(String(i),{phoneVerified:!0,phoneVerificationCode:void 0,phoneVerificationExpiry:void 0}),a.json({message:"Phone number verified successfully",verified:!0})}catch(i){console.error("Verify phone error:",i),a.status(500).json({message:"Internal server error"})}}),e.put("/update-phone",n,async(o,a)=>{try{let i=o.user?._id;if(!i)return a.status(401).json({message:"Not authenticated"});let{phone:r}=o.body;if(!r)return a.status(400).json({message:"Phone number is required"});let s=st(r);if(!s.valid)return a.status(400).json({message:s.error||"Invalid phone number"});let t=s.formatted||je(r);console.log("[Auth] Using SMS provider for phone update verification");let c=et(),u=tt();if(await l.updateUser(String(i),{phone:t,phoneVerificationCode:c,phoneVerificationExpiry:u,phoneVerified:!1}),!await rt(t,c))return a.status(500).json({message:"Failed to send verification SMS. Please try again."});a.json({message:"Phone number updated. Please verify with the code sent to your new number.",requiresVerification:!0,provider:"sms"})}catch(i){console.error("Update phone error:",i),a.status(500).json({message:"Internal server error"})}}),{router:e,authenticateToken:n}}ke();Se();import{eq as E,and as H,ne as is,gte as nt,desc as cs,sql as ge}from"drizzle-orm";import Nt from"web-push";var ot=process.env.VAPID_PUBLIC_KEY||"",It=process.env.VAPID_PRIVATE_KEY||"",us=process.env.VAPID_SUBJECT||"mailto:admin@bus-connect.com";function ls(){return ot&&It?(Nt.setVapidDetails(us,ot,It),console.log("Web push initialized with VAPID keys"),!0):(console.warn("VAPID keys not configured - push notifications disabled"),!1)}function Tt(){return ot}var Ce=class{pushEnabled;constructor(){this.pushEnabled=ls()}async savePushSubscription(e,n){let o=parseInt(e),a=await m.select().from(Q).where(H(E(Q.userId,o),E(Q.endpoint,n.endpoint))).limit(1);if(a.length>0)return{...a[0],_id:a[0].id};let[i]=await m.insert(Q).values({userId:o,endpoint:n.endpoint,keys:n.keys}).$returningId();return{...{id:i.id,userId:o,endpoint:n.endpoint,keys:n.keys,createdAt:new Date},_id:i.id}}async removePushSubscription(e,n){let o=parseInt(e);return(await m.delete(Q).where(H(E(Q.userId,o),E(Q.endpoint,n))))[0]?.affectedRows>0}async getUserSubscriptions(e){let n=parseInt(e);return await m.select().from(Q).where(E(Q.userId,n))}async getPreferences(e){let n=parseInt(e),o=await m.select().from(ee).where(E(ee.userId,n)).limit(1);if(o.length>0)return{...o[0],_id:o[0].id};let[a]=await m.insert(ee).values({userId:n,enablePushNotifications:!0,enableArrivalAlerts:!0,enableDelayAlerts:!0,enableCongestionWarnings:!0,arrivalAlertMinutes:10,delayThresholdMinutes:15}).$returningId();return{_id:a.id,id:a.id,userId:n,enablePushNotifications:!0,enableArrivalAlerts:!0,enableDelayAlerts:!0,enableCongestionWarnings:!0,arrivalAlertMinutes:10,delayThresholdMinutes:15,createdAt:new Date,updatedAt:new Date}}async updatePreferences(e,n){let o=parseInt(e),a=await m.select().from(ee).where(E(ee.userId,o)).limit(1),i={};return n.enablePushNotifications!==void 0&&(i.enablePushNotifications=n.enablePushNotifications),n.enableArrivalAlerts!==void 0&&(i.enableArrivalAlerts=n.enableArrivalAlerts),n.enableDelayAlerts!==void 0&&(i.enableDelayAlerts=n.enableDelayAlerts),n.enableCongestionWarnings!==void 0&&(i.enableCongestionWarnings=n.enableCongestionWarnings),n.arrivalAlertMinutes!==void 0&&(i.arrivalAlertMinutes=n.arrivalAlertMinutes),n.delayThresholdMinutes!==void 0&&(i.delayThresholdMinutes=n.delayThresholdMinutes),a.length>0?await m.update(ee).set({...i,updatedAt:new Date}).where(E(ee.userId,o)):await m.insert(ee).values({userId:o,enablePushNotifications:!0,enableArrivalAlerts:!0,enableDelayAlerts:!0,enableCongestionWarnings:!0,arrivalAlertMinutes:10,delayThresholdMinutes:15,...i}),this.getPreferences(e)}async createNotification(e,n=!0){let a={userId:parseInt(e.userId),type:e.type,title:e.title,body:e.body,data:e.data||null,isRead:!1,sent:!1},[i]=await m.insert(P).values(a).$returningId(),r={...a,id:i.id,_id:i.id,sentAt:null,createdAt:new Date};if(n&&this.pushEnabled){let s=await this.getPreferences(e.userId);this.shouldSendNotification(e.type,s)&&await this.sendPushToUser(e.userId,r)}return r}async getUserNotifications(e,n=50,o=!1){let a=parseInt(e),i=[E(P.userId,a)];return o&&i.push(E(P.isRead,!1)),(await m.select().from(P).where(H(...i)).orderBy(cs(P.createdAt)).limit(n)).map(s=>{let t=s.data;if(typeof t=="string")try{t=JSON.parse(t)}catch{t=null}return{...s,_id:String(s.id),read:s.isRead??!1,sent:s.sent??!1,data:t}})}async getUnreadCount(e){let n=parseInt(e),[o]=await m.select({count:ge`count(*)`}).from(P).where(H(E(P.userId,n),E(P.isRead,!1)));return o.count}async markAsRead(e,n){let o=parseInt(e),a=parseInt(n);return(await m.update(P).set({isRead:!0}).where(H(E(P.id,o),E(P.userId,a))))[0]?.affectedRows>0}async markAllAsRead(e){let n=parseInt(e);return(await m.update(P).set({isRead:!0}).where(H(E(P.userId,n),E(P.isRead,!1))))[0]?.affectedRows||0}async deleteNotification(e,n){let o=parseInt(e),a=parseInt(n);return(await m.delete(P).where(H(E(P.id,o),E(P.userId,a))))[0]?.affectedRows>0}async dismissRideRequestNotifications(e,n){let o=[E(P.type,"ride_request"),ge`JSON_EXTRACT(${P.data}, '$.requestId') = ${e}`];if(n){let i=parseInt(n);o.push(is(P.userId,i))}return(await m.delete(P).where(H(...o)))[0]?.affectedRows||0}async getNotificationsByRequestId(e){return(await m.select().from(P).where(H(E(P.type,"ride_request"),ge`JSON_EXTRACT(${P.data}, '$.requestId') = ${e}`))).map(o=>({...o,_id:o.id}))}shouldSendNotification(e,n){if(!n.enablePushNotifications)return!1;switch(e){case"arrival":return!!n.enableArrivalAlerts;case"delay":return!!n.enableDelayAlerts;case"congestion":return!!n.enableCongestionWarnings;default:return!0}}async sendPushToUser(e,n){if(!this.pushEnabled)return 0;let o=await this.getUserSubscriptions(e),a=0,i=JSON.stringify({title:n.title,body:n.body,type:n.type,icon:"/icon-192.png",badge:"/icon-192.png",tag:`bus-connect-${n.type}-${n._id}`,data:n.data});for(let r of o)try{await Nt.sendNotification({endpoint:r.endpoint,keys:r.keys},i),a++}catch(s){console.error("Push notification failed:",s.message),(s.statusCode===404||s.statusCode===410)&&await this.removePushSubscription(e,r.endpoint)}return a>0&&await m.update(P).set({sent:!0,sentAt:new Date}).where(E(P.id,n._id)),a}calculateDistance(e,n,o,a){let r=this.toRad(o-e),s=this.toRad(a-n),t=Math.sin(r/2)**2+Math.cos(this.toRad(e))*Math.cos(this.toRad(o))*Math.sin(s/2)**2;return 6371*(2*Math.atan2(Math.sqrt(t),Math.sqrt(1-t)))}toRad(e){return e*(Math.PI/180)}estimateArrivalTime(e,n=30){let o=e/n,a=new Date;return a.setTime(a.getTime()+o*60*60*1e3),a}async checkArrivalAlert(e,n,o,a){let i=await this.getPreferences(a);if(!i.enableArrivalAlerts)return!1;let r=this.calculateDistance(n.lat,n.lng,o.lat,o.lng),s=this.estimateArrivalTime(r),t=(s.getTime()-Date.now())/(1e3*60);if(t<=(i.arrivalAlertMinutes||10)&&t>0){let c=parseInt(a),u=new Date(Date.now()-300*1e3);if((await m.select().from(P).where(H(E(P.userId,c),E(P.type,"arrival"),ge`JSON_EXTRACT(${P.data}, '$.scheduleId') = ${e}`,nt(P.createdAt,u))).limit(1)).length===0)return await this.createNotification({userId:a,type:"arrival",title:"Bus Arriving Soon!",body:`Your bus will arrive in approximately ${Math.round(t)} minutes`,data:{scheduleId:e,busLocation:n,arrivalETA:s}}),!0}return!1}async checkDelayAlert(e,n,o,a,i){let r=this.calculateDistance(o.lat,o.lng,a.lat,a.lng),s=this.estimateArrivalTime(r),t=Math.round((s.getTime()-n.getTime())/(1e3*60)),c=0;if(t>0)for(let u of i){let d=await this.getPreferences(u);if(d.enableDelayAlerts&&t>=(d.delayThresholdMinutes||15)){let p=parseInt(u),v=new Date(Date.now()-900*1e3);(await m.select().from(P).where(H(E(P.userId,p),E(P.type,"delay"),ge`JSON_EXTRACT(${P.data}, '$.scheduleId') = ${e}`,nt(P.createdAt,v))).limit(1)).length===0&&(await this.createNotification({userId:u,type:"delay",title:"Bus Delayed",body:`Your bus is running approximately ${t} minutes late`,data:{scheduleId:e,delayMinutes:t,arrivalETA:s,severity:t>30?"high":t>15?"medium":"low"}}),c++)}}return c}async checkCongestion(e){let n=parseInt(e),o=await m.select().from(f).where(H(E(f.routeId,n),E(f.isLive,!0)));if(o.length<3)return null;let a=0,i=0;for(let t of o)if(t.lastLocationLat&&t.departureTime){let c=new Date(t.departureTime).getTime(),u=Date.now();u>c&&(a+=(u-c)/(1e3*60),i++)}let r=i>0?a/i:0,s="low";return r>30||o.length>10?s="high":(r>15||o.length>5)&&(s="medium"),{level:s,activeSchedules:o.length,avgDelay:Math.round(r)}}async sendCongestionWarning(e,n,o){let a=parseInt(e),i=new Date(Date.now()+3600*1e3),r=new Date,s=await m.select({userId:S.userId}).from(S).innerJoin(f,E(S.scheduleId,f.id)).where(H(E(f.routeId,a),nt(f.departureTime,r),ge`${f.departureTime} <= ${i}`,E(S.status,"confirmed"))),t=Array.from(new Set(s.map(u=>u.userId))),c=0;for(let u of t){let d=u.toString();(await this.getPreferences(d)).enableCongestionWarnings&&(await this.createNotification({userId:d,type:"congestion",title:"High Traffic Alert",body:`${n} is experiencing ${o} congestion. Consider alternative routes.`,data:{routeId:e,severity:o}}),c++)}return c}};Ue();import fs from"axios";var ps="https://api.mapbox.com/directions/v5/mapbox/driving-traffic",_t=process.env.MAPBOX_ACCESS_TOKEN;async function gs(l){if(!_t)throw new Error("MAPBOX_ACCESS_TOKEN is not set");if(l.length<2)throw new Error("At least 2 coordinates are required");let e=l.map(([n,o])=>`${n},${o}`).join(";");try{return(await fs.get(`${ps}/${e}`,{params:{access_token:_t,geometries:"geojson",overview:"full",steps:!0,annotations:"distance,duration"}})).data}catch(n){return console.error("Mapbox Directions API error:",n.response?.data||n.message),null}}async function Ie(l){let e=await gs(l);if(e?.routes?.[0]){let n=e.routes[0];return{geometry:n.geometry.coordinates,distance:Math.round(n.distance/1e3*10)/10,duration:Math.round(n.duration/60)}}return null}var F={fuelCostPerKm:.8,maintenanceCostPerKm:.15,driverPayPerKm:.3,baseRatePerKm:.6566,platformFeePercent:10,insuranceFeePerTrip:2,contingencyPercent:8,minimumFarePerSeat:5,busTypeMultipliers:{standard:1,minibus:1,luxury:1,vip:1,executive:1},distanceEstimates:{"accra-kumasi":250,"accra-cape coast":145,"accra-takoradi":225,"accra-ho":160,"accra-tamale":620,"kumasi-tamale":380,"kumasi-sunyani":130,"accra-tema":30,"accra-kasoa":25,"accra-madina":15,"kumasi-obuasi":65,"takoradi-cape coast":85},defaultDistance:50,roadFactor:1.3,avgSpeedKmPerHour:45};function Ne(l,e){let n=l.toLowerCase().trim(),o=e.toLowerCase().trim(),a=`${n}-${o}`,i=`${o}-${n}`;if(F.distanceEstimates[a])return F.distanceEstimates[a];if(F.distanceEstimates[i])return F.distanceEstimates[i];for(let[r,s]of Object.entries(F.distanceEstimates)){let[t,c]=r.split("-");if((n.includes(t)||n.includes(c))&&(o.includes(t)||o.includes(c)))return s}return F.defaultDistance}function Te(l){return Math.round(l/F.avgSpeedKmPerHour*60)}function Rt(l){if(!l)return"standard";let e=(l.make||"").toLowerCase(),n=(l.model||"").toLowerCase(),o=l.capacity||15;return n.includes("vip")||n.includes("executive")||e.includes("mercedes")||e.includes("volvo")?"executive":n.includes("luxury")||e.includes("man")||n.includes("sprinter")?"luxury":o<=15?"minibus":"standard"}function kt(l,e,n,o){let a=Ne(l,e),i=Te(a),r=Rt(o),s=F.busTypeMultipliers[r]||1,t=a*F.baseRatePerKm*s;t=Math.max(t,F.minimumFarePerSeat),t=Math.ceil(t*2)/2;let c=t*n,u=c*.8,d=c*.1,p=c*.1;return{distance:a,duration:i,capacity:n,busType:r,fuelCost:Number((u*.4).toFixed(2)),maintenanceCost:Number((u*.2).toFixed(2)),driverPay:Number((u*.4).toFixed(2)),insuranceFee:F.insuranceFeePerTrip,baseTripCost:Number(u.toFixed(2)),platformFee:Number(d.toFixed(2)),contingencyBuffer:Number(p.toFixed(2)),totalTripCost:Number(c.toFixed(2)),pricePerSeat:t}}function Dt(l,e){return l<e}async function Et(l){try{let{storage:e}=await Promise.resolve().then(()=>(qe(),pt)),n=await e.findBusStopByName(l);return n?.location?(console.log(`[Fare] Found in database: "${l}" -> (${n.location.lat}, ${n.location.lng})`),n.location):null}catch(e){return console.warn(`[Fare] Database lookup failed for "${l}":`,e),null}}async function ys(l,e,n,o){try{console.log(`[Fare] Getting route data for: ${l} -> ${e}`);let a=n||await Et(l),i=o||await Et(e);if(a&&Math.abs(a.lat)<.1&&Math.abs(a.lng)<.1&&(console.warn(`[Fare] Start Coordinates for "${l}" are near 0,0, treating as MISSING.`),a=null),i&&Math.abs(i.lat)<.1&&Math.abs(i.lng)<.1&&(console.warn(`[Fare] End Coordinates for "${e}" are near 0,0, treating as MISSING.`),i=null),a||(console.log(`[Fare] "${l}" not in database, trying Mapbox geocoding...`),a=await xe(l)),i||(console.log(`[Fare] "${e}" not in database, trying Mapbox geocoding...`),i=await xe(e)),a||console.warn(`[Fare] Failed to find coordinates for START: "${l}"`),i||console.warn(`[Fare] Failed to find coordinates for END: "${e}"`),!a||!i){console.warn("[Fare] Using estimated distance due to coordinate lookup failure");let s=Ne(l,e);return{distance:s,duration:Te(s),source:"estimated"}}console.log(`[Fare] Coordinates: Start(${a.lat}, ${a.lng}), End(${i.lat}, ${i.lng})`);let r=await Ie([[a.lng,a.lat],[i.lng,i.lat]]);if(!r){console.warn("[Fare] Failed to get route from Mapbox Directions API, using estimated distance");let s=Ne(l,e);return{distance:s,duration:Te(s),source:"estimated",coordinates:{start:a,end:i}}}if(console.log(`[Fare] Mapbox route: ${r.distance} km, ${r.duration} min`),r.distance<1&&l.toLowerCase()!==e.toLowerCase()){console.warn(`[Fare] Mapbox returned <1km for potentially long route: "${l}" to "${e}". Using fallback estimate.`);let s=Ne(l,e);return{distance:s,duration:Te(s),source:"estimated",coordinates:{start:a,end:i}}}return{distance:r.distance,duration:r.duration,source:"mapbox",coordinates:{start:a,end:i},geometry:r.geometry}}catch(a){console.error("[Fare] Error getting route data:",a.message||a);let i=Ne(l,e);return{distance:i,duration:Te(i),source:"estimated"}}}async function de(l,e,n,o,a,i){let r=await ys(l,e,a,i),s=r.distance,t=r.duration,c=Rt(o),u=F.busTypeMultipliers[c]||1,d=s*F.baseRatePerKm*u;console.log(`[Fare Debug] Distance: ${s}km, Rate: ${F.baseRatePerKm}, Multiplier: ${u}, Calculated Price: ${d.toFixed(2)}`),d=Math.max(d,F.minimumFarePerSeat),d=Math.ceil(d*2)/2,console.log(`[Fare Debug] Final Price after Min/Round: GHS ${d.toFixed(2)}`);let p=d*n,v=p*.8,y=p*.1,N=p*.1;return{distance:Number(s.toFixed(1)),duration:t,capacity:n,busType:c,fuelCost:Number((v*.4).toFixed(2)),maintenanceCost:Number((v*.2).toFixed(2)),driverPay:Number((v*.4).toFixed(2)),insuranceFee:F.insuranceFeePerTrip,baseTripCost:Number(v.toFixed(2)),platformFee:Number(y.toFixed(2)),contingencyBuffer:Number(N.toFixed(2)),totalTripCost:Number(p.toFixed(2)),pricePerSeat:d,dataSource:r.source,coordinates:r.coordinates,routeGeometry:r.geometry}}Ue();Se();import{z as D}from"zod";var ce={validation:D.object({message:D.string(),field:D.string().optional()}),notFound:D.object({message:D.string()}),internal:D.object({message:D.string()})},ye={buses:{list:{method:"GET",path:"/api/buses",responses:{200:D.array(D.custom())}},create:{method:"POST",path:"/api/buses",input:Re,responses:{201:D.custom(),400:ce.validation}},update:{method:"PUT",path:"/api/buses/:id",input:Re.partial(),responses:{200:D.custom(),404:ce.notFound}}},routes:{list:{method:"GET",path:"/api/routes",responses:{200:D.array(D.custom())}},create:{method:"POST",path:"/api/routes",input:We,responses:{201:D.custom(),400:ce.validation}}},schedules:{list:{method:"GET",path:"/api/schedules",input:D.object({from:D.string().optional(),to:D.string().optional(),date:D.string().optional()}).optional(),responses:{200:D.array(D.custom())}},create:{method:"POST",path:"/api/schedules",input:Ge,responses:{201:D.custom(),400:ce.validation}}},bookings:{list:{method:"GET",path:"/api/bookings",responses:{200:D.array(D.custom())}},create:{method:"POST",path:"/api/bookings",input:He,responses:{201:D.custom(),400:ce.validation}},cancel:{method:"POST",path:"/api/bookings/:id/cancel",responses:{200:D.custom(),404:ce.notFound}}},profile:{get:{method:"GET",path:"/api/profile",responses:{200:D.custom(),404:ce.notFound}},update:{method:"PUT",path:"/api/profile",responses:{200:D.any(),404:ce.notFound}}}};import{WebSocketServer as hs,WebSocket as Lt}from"ws";var Be=new Map;function Oe(l,e){l.forEach(n=>{let o=Be.get(n);o&&o.readyState===1&&o.send(JSON.stringify(e))})}function jt(l){let e=new hs({noServer:!0});l.on("upgrade",(i,r,s)=>{let{pathname:t}=new URL(i.url,`http://${i.headers.host}`);t==="/ws/tracking"&&e.handleUpgrade(i,r,s,c=>{e.emit("connection",c,i)})});let n=new Map,o=new Map,a=new Map;return e.on("connection",i=>{M("New WebSocket connection for tracking","websocket"),i.on("message",r=>{try{let s=JSON.parse(r.toString());if(s.type==="RIDE_REQUEST_SUBSCRIBE"){let t=s.payload?.userId;t&&(Be.set(t,i),M(`Driver ${t} subscribed to ride request updates`,"websocket"))}if(s.type==="TRACKING_SUBSCRIBE"){n.has(s.scheduleId)||n.set(s.scheduleId,new Set),n.get(s.scheduleId)?.add(i),M(`Client subscribed to schedule: ${s.scheduleId}`,"websocket");let t=o.get(s.scheduleId);t&&(i.send(JSON.stringify({type:"BUS_LOCATION",scheduleId:s.scheduleId,location:t})),M(`Sent cached bus location for schedule: ${s.scheduleId}`,"websocket"));let c=a.get(s.scheduleId);c&&c.size>0&&(c.forEach((u,d)=>{i.send(JSON.stringify({type:"PASSENGER_LOCATION",scheduleId:s.scheduleId,userId:d,userName:u.userName,location:u.location}))}),M(`Sent ${c.size} cached passenger locations for schedule: ${s.scheduleId}`,"websocket"))}if(s.type==="LOCATION_UPDATE"){o.set(s.scheduleId,s.payload);let t=n.get(s.scheduleId);if(t){let c=JSON.stringify({type:"BUS_LOCATION",scheduleId:s.scheduleId,location:s.payload});t.forEach(u=>{u!==i&&u.readyState===Lt.OPEN&&u.send(c)})}}if(s.type==="PASSENGER_LOCATION_UPDATE"){let t=s.payload?.userId,c=s.payload?.userName||"Passenger",u={lat:s.payload?.lat,lng:s.payload?.lng};M(`Passenger location update: ${c} (${t}) for schedule ${s.scheduleId}`,"websocket"),t&&(a.has(s.scheduleId)||a.set(s.scheduleId,new Map),a.get(s.scheduleId)?.set(t,{userName:c,location:u,lastUpdate:Date.now()}));let d=n.get(s.scheduleId);if(d&&d.size>0){let p=JSON.stringify({type:"PASSENGER_LOCATION",scheduleId:s.scheduleId,userId:t,userName:c,location:u}),v=0;d.forEach(y=>{y!==i&&y.readyState===Lt.OPEN&&(y.send(p),v++)}),M(`Broadcast passenger location to ${v} subscriber(s)`,"websocket")}else M(`No active subscribers for schedule ${s.scheduleId} - location cached for later`,"websocket")}}catch(s){console.error("WebSocket message error:",s)}}),i.on("close",()=>{n.forEach((r,s)=>{r.has(i)&&(r.delete(i),r.size===0&&n.delete(s))}),Be.forEach((r,s)=>{r===i&&(Be.delete(s),M(`Driver ${s} unsubscribed from ride requests`,"websocket"))}),M("WebSocket connection closed","websocket")})}),e}async function Ct(l,e){let{router:n,authenticateToken:o}=wt(h);e.use("/api/auth",n),e.post("/api/driver/status-sync",o,async(r,s)=>{}),e.put("/api/test-put",(r,s)=>{console.log("[API] Public test-put called"),s.json({message:"PUT works",body:r.body})}),e.post("/api/fare/estimate",o,async(r,s)=>{try{if(!r.user)return s.status(401).json({message:"Unauthorized"});let t=r.user._id.toString(),{startLocation:c,endLocation:u,startCoords:d,endCoords:p}=r.body;if(!c||!u)return s.status(400).json({message:"Start and end locations required"});let v=await h.findUserById(t),y=v?.driverDetails?.vehicleParams?.capacity||15,N=v?.driverDetails?.vehicleParams,A=await de(c,u,y,N,d,p);console.log(`[Fare] Calculated: ${A.distance}km, GHS ${A.pricePerSeat}/seat (${A.dataSource})`),s.json(A)}catch(t){console.error("Fare Estimate Error:",t),s.status(500).json({message:t.message})}}),e.post("/api/fare/calculate",o,async(r,s)=>{try{let{startLocation:t,endLocation:c,vehicleParams:u,capacity:d}=r.body;if(!t||!c)return s.status(400).json({message:"Start and end locations required"});let p=await de(t,c,d||15,u);s.json(p)}catch(t){console.error("Fare Calculation Error:",t),s.status(500).json({message:t.message})}}),e.post("/api/schedules",o,async(r,s)=>{try{if(!r.user)return s.status(401).json({message:"Unauthorized"});let t=r.user._id.toString();if(r.body.startLocation&&r.body.endLocation){let c=await h.findUserById(t),u=c?.driverDetails?.vehicleParams?.capacity||15,d=c?.driverDetails?.vehicleParams,p=await de(r.body.startLocation,r.body.endLocation,u,d,r.body.startCoords,r.body.endCoords);console.log(`[Schedule] Creating route with ${p.distance}km distance (${p.dataSource})`);let v=[];p.coordinates?.start&&v.push({name:r.body.startLocation,location:p.coordinates.start,order:0}),p.coordinates?.end&&v.push({name:r.body.endLocation,location:p.coordinates.end,order:1});let y=await h.createRoute({name:`${r.body.startLocation} to ${r.body.endLocation}`,startLocation:r.body.startLocation,endLocation:r.body.endLocation,stops:v,distance:p.distance.toString(),estimatedDuration:p.duration,geometry:p.routeGeometry}),N=await h.createSchedule({routeId:y._id.toString(),route:{_id:y._id,startLocation:r.body.startLocation,endLocation:r.body.endLocation,coordinates:p.coordinates,geometry:p.routeGeometry},driverId:t,price:p.pricePerSeat,departureTime:new Date(r.body.departureTime),capacity:u,availableSeats:u,stops:v,fareBreakdown:{distance:p.distance,duration:p.duration,busType:p.busType,baseTripCost:p.baseTripCost,platformFee:p.platformFee,totalTripCost:p.totalTripCost,dataSource:p.dataSource}});return s.status(201).json(N)}s.status(400).json({message:"Invalid form data"})}catch(t){console.error("Schedule Error:",t),s.status(500).json({message:t.message})}}),e.get("/api/schedules",async(r,s)=>{try{console.log("GET /api/schedules params:",r.query);let t=await h.getSchedules(r.query);console.log(`Found ${t.length} schedules`),s.json(t)}catch(t){console.error("Get Schedules Error:",t),s.status(500).json({message:t.message})}}),e.get("/api/schedules/:id",async(r,s)=>{console.log(`[API] GET /api/schedules/${r.params.id} called`);try{let t=await h.getSchedule(r.params.id);if(!t)return console.warn(`[API] Schedule NOT FOUND: ${r.params.id}`),s.status(404).json({message:"Schedule not found"});s.json(t)}catch(t){console.error(`[API] Single Schedule Error: ${t.message}`),s.status(500).json({message:t.message})}}),e.put("/api/schedules/:id",o,async(r,s)=>{try{if(!r.user)return s.status(401).json({message:"Unauthorized"});let t=r.params.id,c=await h.getSchedule(t);if(!c)return s.status(404).json({message:"Schedule not found"});if(c.driverId!==r.user._id.toString())return s.status(403).json({message:"Not authorized to edit this schedule"});let u=Dt(c.availableSeats||0,c.capacity||15),d={departureTime:new Date(r.body.departureTime)};if(r.body.startLocation&&r.body.startLocation!==c.route?.startLocation||r.body.endLocation&&r.body.endLocation!==c.route?.endLocation){if(u)return s.status(400).json({message:"Cannot change route after seats have been booked. Price is locked."});let y=await h.findUserById(r.user._id.toString()),N=y?.driverDetails?.vehicleParams?.capacity||c.capacity||15,A=y?.driverDetails?.vehicleParams,k=await de(r.body.startLocation||c.route?.startLocation,r.body.endLocation||c.route?.endLocation,N,A,r.body.startCoords,r.body.endCoords);console.log(`[Schedule] Updating route with ${k.distance}km distance (${k.dataSource})`),d["route.startLocation"]=r.body.startLocation,d["route.endLocation"]=r.body.endLocation,d.price=k.pricePerSeat,d.fareBreakdown={distance:k.distance,duration:k.duration,busType:k.busType,baseTripCost:k.baseTripCost,platformFee:k.platformFee,totalTripCost:k.totalTripCost,dataSource:k.dataSource}}let v=await h.updateSchedule(t,d);s.json(v)}catch(t){console.error("Update Schedule Error:",t),s.status(500).json({message:t.message})}}),e.delete("/api/schedules/:id",o,async(r,s)=>{try{if(!r.user)return s.status(401).json({message:"Unauthorized"});let t=r.params.id,c=await h.getSchedule(t);if(!c)return s.status(404).json({message:"Schedule not found"});if(c.driverId!==r.user._id.toString())return s.status(403).json({message:"Not authorized to delete this schedule"});await h.deleteSchedule(t)?s.json({message:"Schedule deleted successfully"}):s.status(404).json({message:"Schedule not found"})}catch(t){console.error("Delete Schedule Error:",t),s.status(500).json({message:t.message})}}),e.post("/api/schedules/:id/toggle-live",o,async(r,s)=>{try{if(!r.user||r.user.role!=="driver")return s.status(403).json({message:"Only drivers can toggle live status"});let{isLive:t}=r.body,c=r.params.id,u=await h.toggleScheduleLive(c,r.user._id,!!t);if(!u)return s.status(404).json({message:"Schedule not found"});s.json(u)}catch(t){console.error("Toggle Schedule Live Error:",t),s.status(500).json({message:t.message})}}),e.get(ye.bookings.list.path,o,async(r,s)=>{try{if(!r.user)return s.status(401).json({message:"Unauthorized"});let t=r.user._id.toString(),c=await h.getBookings(t);s.json(c)}catch(t){console.error("Get Bookings Error:",t),s.status(500).json({message:t.message})}}),e.post(ye.bookings.create.path,o,async(r,s)=>{try{if(!r.user)return s.status(401).json({message:"Unauthorized"});let t=r.user._id.toString(),c=await h.getSchedule(r.body.scheduleId);if(!c)return s.status(404).json({message:"Schedule not found"});if(c.availableSeats<=0)return s.status(400).json({message:"No seats available"});let u=await h.getBookingsBySchedule(r.body.scheduleId,"confirmed"),d=new Set(u.map(N=>N.seatNumber)),p=0;for(let N=1;N<=c.capacity;N++)if(!d.has(N)){p=N;break}if(p===0)return s.status(400).json({message:"No actual seats found (mismatch error)"});let v={userId:t,scheduleId:r.body.scheduleId,seatNumber:p,pickup:r.body.pickup||c.route?.startLocation,dropoff:r.body.dropoff||c.route?.endLocation,price:r.body.price||c.price,status:r.body.status||"confirmed",createdAt:new Date},y=await h.createBooking(v);s.status(201).json({...y,seatNumber:p})}catch(t){console.error("Create Booking Error:",t),s.status(500).json({message:t.message})}}),e.post("/api/bookings/:id/cancel",o,async(r,s)=>{try{if(!r.user)return s.status(401).json({message:"Unauthorized"});let t=r.params.id,c=r.user._id.toString(),u=await h.cancelBooking(t,c);u?s.json(u):s.status(404).json({message:"Booking not found or not authorized"})}catch(t){console.error("Cancel Booking Error:",t),s.status(500).json({message:t.message})}}),e.post("/api/bookings/group",o,async(r,s)=>{try{if(!r.user)return s.status(401).json({message:"Unauthorized"});let t=r.user._id.toString(),{scheduleId:c,numberOfSeats:u,organizationName:d,organizationType:p,contactName:v,contactPhone:y,notes:N}=r.body;if(!c||!u||u<1)return s.status(400).json({message:"Invalid booking data"});let A=await h.getSchedule(c);if(!A)return s.status(404).json({message:"Schedule not found"});if(A.availableSeats<u)return s.status(400).json({message:`Only ${A.availableSeats} seats available`,availableSeats:A.availableSeats});let k={userId:t,scheduleId:c,numberOfSeats:u,organizationName:d||null,organizationType:p||"private",contactName:v,contactPhone:y,notes:N||null,status:"confirmed",isGroupBooking:!0,createdAt:new Date};if(!await h.atomicDecrementSeats(c,u))return s.status(400).json({message:"Not enough seats available"});let W=await h.insertBookingDirect(k);s.status(201).json({_id:W.insertedId,...k,seatsBooked:u})}catch(t){console.error("Group Booking Error:",t),s.status(500).json({message:t.message})}}),e.delete("/api/bookings/:id",o,async(r,s)=>{try{if(!r.user)return s.status(401).json({message:"Unauthorized"});let t=r.params.id;await h.deleteBooking(t)?s.json({message:"Booking deleted"}):s.status(404).json({message:"Booking not found"})}catch(t){s.status(500).json({message:t.message})}}),e.post("/api/schedules/:id/complete",o,async(r,s)=>{try{if(!r.user||r.user.role!=="driver")return s.status(403).json({message:"Unauthorized"});let t=r.params.id,c=await h.getSchedule(t);if(!c)return s.status(404).json({message:"Schedule not found"});if(c.driverId!==r.user._id.toString())return s.status(403).json({message:"Not authorized"});await h.markScheduleBookingsCompleted(t),s.json({message:"Trip completed"})}catch(t){s.status(500).json({message:t.message})}}),e.get(ye.profile.get.path,o,async(r,s)=>{try{if(!r.user)return s.status(401).json({message:"Unauthorized"});let t=r.user._id.toString(),c=await h.getProfile(t);c||(c=await h.createProfile(t,{role:r.user.role}));let u={...c,email:r.user.email,firstName:r.user.firstName,lastName:r.user.lastName,role:r.user.role,createdAt:c?.createdAt||new Date};s.json(u)}catch(t){console.error("Get Profile Error:",t),s.status(500).json({message:t.message})}}),e.put(ye.profile.update.path,o,async(r,s)=>{console.log(`[API] PUT ${ye.profile.update.path} called`),console.log("[Profile] Request body:",r.body);try{if(!r.user)return s.status(401).json({message:"Unauthorized"});let t=r.user._id.toString(),{firstName:c,lastName:u,driverDetails:d,isLive:p,phone:v}=r.body,y={};c&&(y.firstName=c),u&&(y.lastName=u),d&&(y.driverDetails=d),p!==void 0&&(y.isLive=p),v!==void 0&&(y.phone=v),console.log(`[Profile] Updating user ${t} with:`,y);let N=await h.updateUser(t,y);if(console.log("[Profile] Updated user phone:",N?.phone),!N)return s.status(404).json({message:"User not found"});s.json({firstName:N.firstName,lastName:N.lastName,driverDetails:N.driverDetails,isLive:N.isLive,phone:N.phone})}catch(t){console.error("Update Profile Error:",t),s.status(500).json({message:t.message})}}),e.get("/api/routes",async(r,s)=>{try{let t=await h.getRoutes();s.json(t)}catch(t){console.error("Get Routes Error:",t),s.status(500).json({message:t.message})}}),e.get("/api/routes/search",async(r,s)=>{try{let{q:t,start:c,end:u,busType:d}=r.query,p=await h.searchRoutes({query:t,start:c,end:u,busType:d});s.json(p)}catch(t){console.error("Search Routes Error:",t),s.status(500).json({message:t.message})}}),e.get("/api/routes/:id",async(r,s)=>{try{let t=await h.getRoute(r.params.id);if(!t)return s.status(404).json({message:"Route not found"});if(t.stops&&Array.isArray(t.stops)){let c=await h.getBusStops(),u=new Map(c.map(d=>[d.name.toLowerCase().trim(),d]));t.stops=t.stops.map(d=>{let p=u.get(d.toLowerCase().trim());return p&&p.location?{name:d,location:p.location}:{name:d,location:null}})}s.json(t)}catch(t){s.status(500).json({message:t.message})}}),e.get("/api/bus-stops",async(r,s)=>{try{let t=await h.getBusStops();s.json(t)}catch(t){console.error("Get Bus Stops Error:",t),s.status(500).json({message:t.message})}}),e.get("/api/locations/search",o,async(r,s)=>{try{let{q:t}=r.query;if(!t)return s.json([]);let c=await $e(t);s.json(c)}catch(t){console.error("Location Search Error:",t),s.status(500).json({message:t.message})}}),e.get("/api/bus-stops/search",async(r,s)=>{try{let t=r.query.q,c=r.query.region;if(!t)return s.status(400).json({error:"Query parameter required"});let u=await h.searchBusStops(t,c);s.json(u)}catch(t){console.error("Search Bus Stops Error:",t),s.status(500).json({message:t.message})}}),e.get("/api/maps/geocode",async(r,s)=>{try{let t=r.query.q;if(!t)return s.status(400).json({error:"Query parameter required"});let c=await Promise.resolve().then(()=>(Ue(),At)).then(u=>u.searchMaps(t));s.json(c||[])}catch(t){console.error("Geocode Error:",t),s.status(500).json({message:t.message})}}),e.post("/api/directions",async(r,s)=>{try{let{coordinates:t}=r.body;if(!t||!Array.isArray(t)||t.length<2)return s.status(400).json({error:"At least 2 coordinates required"});let c=await Ie(t);c?s.json(c):s.status(404).json({error:"No route found"})}catch(t){console.error("Directions Error:",t),s.status(500).json({message:t.message})}}),e.get("/api/debug/fare",async(r,s)=>{try{let t=r.query.start||"Accra",c=r.query.end||"Kumasi",u=parseInt(r.query.capacity)||15;console.log(`[Debug] Testing fare calculation: ${t} -> ${c}`),console.log(`[Debug] MAPBOX_ACCESS_TOKEN: ${process.env.MAPBOX_ACCESS_TOKEN?"SET ("+process.env.MAPBOX_ACCESS_TOKEN.substring(0,10)+"...)":"NOT SET"}`);let d=await de(t,c,u);s.json({input:{start:t,end:c,capacity:u},result:d,mapboxTokenSet:!!process.env.MAPBOX_ACCESS_TOKEN})}catch(t){console.error("[Debug] Fare calculation error:",t),s.status(500).json({error:t.message,stack:t.stack})}}),e.get("/api/analytics/demand",o,async(r,s)=>{try{let t=await h.getDemandAnalytics();s.json(t)}catch(t){console.error("Analytics Demand Error:",t),s.status(500).json({message:t.message})}}),e.get("/api/analytics/peak-hours",o,async(r,s)=>{try{let t=await h.getPeakHoursAnalytics();s.json(t)}catch(t){console.error("Analytics Peak Hours Error:",t),s.status(500).json({message:t.message})}}),e.get("/api/analytics/revenue",o,async(r,s)=>{try{if(!r.user)return s.status(401).json({message:"Unauthorized"});let t=r.user._id.toString(),c=r.user.role==="driver",u=await h.getRevenueAnalytics(c?parseInt(t):void 0);s.json(u)}catch(t){console.error("Analytics Revenue Error:",t),s.status(500).json({message:t.message})}}),e.post("/api/reports",o,async(r,s)=>{try{if(!r.user)return s.status(401).json({message:"Unauthorized"});let t=r.user._id.toString(),{type:c,scheduleId:u,routeId:d,details:p,location:v}=r.body,y={userId:t,type:c,scheduleId:u||null,routeId:d||null,details:p||null,location:v||null,status:"pending",createdAt:new Date},N=await h.createReport(y);s.status(201).json(N)}catch(t){console.error("Report Error:",t),s.status(500).json({message:t.message})}}),e.get("/api/reports/route/:routeId",async(r,s)=>{try{let t=await h.getRouteReports(r.params.routeId,new Date(Date.now()-864e5));s.json(t)}catch(t){s.status(500).json({message:t.message})}}),e.post("/api/sos/alert",o,async(r,s)=>{try{if(!r.user)return s.status(401).json({message:"Unauthorized"});let t=r.user._id.toString(),{scheduleId:c,location:u,message:d}=r.body,p={userId:t,scheduleId:c,location:u,message:d||"Emergency alert",status:"active",createdAt:new Date};if(await h.createSOSAlert(p),c){let v=await h.getSchedule(c);v?.driverId&&console.log(`SOS Alert for driver ${v.driverId} from passenger ${t}`)}s.status(201).json({success:!0,message:"Alert sent"})}catch(t){console.error("SOS Alert Error:",t),s.status(500).json({message:t.message})}});let a=new Ce;e.get("/api/notifications/vapid-public-key",(r,s)=>{let t=Tt();if(!t)return s.status(503).json({message:"Push notifications not configured"});s.json({publicKey:t})}),e.post("/api/notifications/subscribe",o,async(r,s)=>{try{if(!r.user)return s.status(401).json({message:"Unauthorized"});let t=r.user._id.toString(),{subscription:c}=r.body;if(!c?.endpoint||!c?.keys)return s.status(400).json({message:"Invalid subscription data"});let u=await a.savePushSubscription(t,c);s.json({success:!0,subscription:u})}catch(t){console.error("Push Subscribe Error:",t),s.status(500).json({message:t.message})}}),e.post("/api/notifications/unsubscribe",o,async(r,s)=>{try{if(!r.user)return s.status(401).json({message:"Unauthorized"});let t=r.user._id.toString(),{endpoint:c}=r.body;await a.removePushSubscription(t,c),s.json({success:!0})}catch(t){console.error("Push Unsubscribe Error:",t),s.status(500).json({message:t.message})}}),e.get("/api/notifications",o,async(r,s)=>{try{if(!r.user)return s.status(401).json({message:"Unauthorized"});let t=r.user._id.toString(),c=parseInt(r.query.limit)||50,u=r.query.unreadOnly==="true",d=await a.getUserNotifications(t,c,u);s.json(d)}catch(t){console.error("Get Notifications Error:",t),s.status(500).json({message:t.message})}}),e.get("/api/notifications/unread-count",o,async(r,s)=>{try{if(!r.user)return s.status(401).json({message:"Unauthorized"});let t=r.user._id.toString(),c=await a.getUnreadCount(t);s.json({count:c})}catch(t){console.error("Unread Count Error:",t),s.status(500).json({message:t.message})}}),e.put("/api/notifications/:id/read",o,async(r,s)=>{try{if(!r.user)return s.status(401).json({message:"Unauthorized"});let t=r.user._id.toString(),c=await a.markAsRead(r.params.id,t);s.json({success:c})}catch(t){console.error("Mark Read Error:",t),s.status(500).json({message:t.message})}}),e.post("/api/notifications/read-all",o,async(r,s)=>{try{if(!r.user)return s.status(401).json({message:"Unauthorized"});let t=r.user._id.toString(),c=await a.markAllAsRead(t);s.json({success:!0,count:c})}catch(t){console.error("Mark All Read Error:",t),s.status(500).json({message:t.message})}}),e.delete("/api/notifications/:id",o,async(r,s)=>{try{if(!r.user)return s.status(401).json({message:"Unauthorized"});let t=r.user._id.toString(),c=await a.deleteNotification(r.params.id,t);s.json({success:c})}catch(t){console.error("Delete Notification Error:",t),s.status(500).json({message:t.message})}}),e.get("/api/notifications/preferences",o,async(r,s)=>{try{if(!r.user)return s.status(401).json({message:"Unauthorized"});let t=r.user._id.toString(),c=await a.getPreferences(t);s.json(c)}catch(t){console.error("Get Preferences Error:",t),s.status(500).json({message:t.message})}}),e.put("/api/notifications/preferences",o,async(r,s)=>{try{if(!r.user)return s.status(401).json({message:"Unauthorized"});let t=r.user._id.toString(),c=await a.updatePreferences(t,r.body);s.json(c)}catch(t){console.error("Update Preferences Error:",t),s.status(500).json({message:t.message})}}),e.get("/api/email/test-connection",o,async(r,s)=>{try{if(!r.user)return s.status(401).json({message:"Unauthorized"});await ht()?s.json({success:!0,message:"SMTP connection successful"}):s.status(503).json({success:!1,message:"SMTP connection failed. Check your .env SMTP_USER and SMTP_PASS settings."})}catch(t){console.error("Email Test Connection Error:",t),s.status(500).json({success:!1,message:t.message})}}),e.post("/api/email/test-send",o,async(r,s)=>{try{if(!r.user)return s.status(401).json({message:"Unauthorized"});let t=ve();await we(r.user.email,r.user.firstName,t)?s.json({success:!0,message:`Test email sent to ${r.user.email}. Check your inbox (and spam folder).`}):s.status(500).json({success:!1,message:"Failed to send test email. Check server logs for details."})}catch(t){console.error("Email Test Send Error:",t),s.status(500).json({success:!1,message:t.message})}}),e.post("/api/ride-requests",o,async(r,s)=>{try{if(!r.user)return s.status(401).json({message:"Unauthorized"});let t=r.user._id.toString(),{from:c,to:u,seats:d,departureTime:p,notes:v}=r.body;if(!c||!u)return s.status(400).json({message:"From and To locations are required"});let y=await h.findUserById(t),N=y?.phone||"",A=y?`${y.firstName} ${y.lastName}`:`${r.user.firstName} ${r.user.lastName}`;console.log(`[RideRequest] User ID: ${t}`),console.log("[RideRequest] Fresh user from DB:",y?{_id:y._id,phone:y.phone,firstName:y.firstName}:"NOT FOUND"),console.log(`[RideRequest] New request: ${c} -> ${u}, phone: "${N}"`);let k=0,j=0;try{let x=await de(c,u,15);k=x.pricePerSeat,j=x.distance,console.log(`[RideRequest] Calculated fare: GHS ${k} for ${j}km`)}catch(x){console.error("[RideRequest] Failed to calculate fare:",x);let re=kt(c,u,15);k=re.pricePerSeat,j=re.distance}let W=await h.findLiveSchedulesForRoute(c,u);console.log(`[RideRequest] Found ${W.length} live schedules matching route`);let Z=Array.from(new Set(W.map(x=>x.driverId).filter(Boolean)));console.log(`[RideRequest] Unique driver IDs from schedules: ${Z.length}`);let Y=await h.findLiveDriversByIds(Z);console.log(`[RideRequest] Found ${Y.length} LIVE drivers on matching routes`);let Ve=Y.filter(x=>x._id?.toString()!==t);if(Ve.length===0)return s.status(404).json({message:"No live drivers found on this route. Please try again later or choose a different route.",notifiedCount:0});let ct={userId:t,userName:A,userPhone:N,from:c,to:u,seats:parseInt(d)||1,departureTime:p?new Date(p):new Date,notes:v||"",status:"pending",estimatedFare:k,estimatedDistance:j,notifiedDrivers:Ve.map(x=>x._id?.toString()),acceptedBy:null,acceptedAt:null,createdAt:new Date},Ae=(await h.createRideRequest(ct)).id;console.log(`[RideRequest] Saved with ID: ${Ae}`);let ze=new Map;for(let x of W)x.driverId&&!ze.has(x.driverId.toString())&&ze.set(x.driverId.toString(),(x._id||x.id).toString());let he=[];for(let x of Ve){let re=x._id?.toString();if(re)try{await a.createNotification({userId:re,type:"ride_request",title:"New Ride Request!",body:`${A} needs a ride from ${c} to ${u} (${d||1} seat${(d||1)>1?"s":""}) \u2022 GHS ${k.toFixed(2)}/seat`,data:{requestId:Ae.toString(),scheduleId:ze.get(re)||void 0,passengerId:t,passengerName:A,passengerPhone:N,from:c,to:u,seats:d||1,estimatedFare:k,estimatedDistance:j,departureTime:p||new Date().toISOString()}}),he.push(re),console.log(`[RideRequest] Notification sent to driver ${re}`)}catch(Vt){console.error(`[RideRequest] Failed to notify driver ${re}:`,Vt)}}Oe(he,{type:"NEW_RIDE_REQUEST",requestId:Ae.toString(),passengerName:`${r.user.firstName} ${r.user.lastName}`,from:c,to:u,seats:d||1,estimatedFare:k,estimatedDistance:j,departureTime:p||new Date().toISOString(),notes:v||""}),s.status(201).json({_id:Ae,...ct,estimatedFare:k,estimatedDistance:j,notifiedCount:he.length,message:`Request sent to ${he.length} live driver${he.length>1?"s":""} on this route`})}catch(t){console.error("[RideRequest] Error:",t),s.status(500).json({message:t.message})}}),e.get("/api/ride-requests",o,async(r,s)=>{try{if(!r.user)return s.status(401).json({message:"Unauthorized"});let t=await h.getRecentRideRequests();s.json(t)}catch(t){console.error("[RideRequest] GET Error:",t),s.status(500).json({message:t.message})}}),e.post("/api/ride-requests/:id/accept",o,async(r,s)=>{try{if(!r.user)return s.status(401).json({message:"Unauthorized"});if(r.user.role!=="driver")return s.status(403).json({message:"Only drivers can accept ride requests"});let t=r.params.id,c=r.user._id.toString(),{scheduleId:u}=r.body;console.log(`[RideRequest] Driver ${c} accepting request ${t}, scheduleId=${u||"auto"}`);let d=await h.findRideRequest(t,{status:"pending"});if(!d)return s.status(404).json({message:"Ride request not found or already accepted"});let p=d.notifiedDrivers||[];if(typeof p=="string")try{p=JSON.parse(p)}catch{p=[]}let v=p.map(Y=>String(Y));if(!v.includes(String(c)))return console.log(`[RideRequest] Driver ${c} not in notified list: ${JSON.stringify(v)}`),s.status(403).json({message:"You were not notified about this ride request"});let y=null,N=await h.getSchedules({driverId:c});if(console.log(`[RideRequest] Found ${N.length} schedules for driver ${c}`),u&&(y=N.find(Y=>String(Y._id)===String(u)||String(Y.id)===String(u))),y||(y=N.find(Y=>Y.isLive||Y.driver?.isLive)||N[0]),!y)return s.status(400).json({message:"No schedule found. Please create a trip first."});console.log(`[RideRequest] Using schedule ${y._id}, isLive=${y.isLive}, availableSeats=${y.availableSeats}`);let A=d.seats||1;if((y.availableSeats||0)<A)return s.status(400).json({message:`Not enough seats available. You have ${y.availableSeats||0} seats, but ${A} are needed.`});await h.updateRideRequest(t,{status:"accepted",acceptedBy:c,acceptedByName:`${r.user.firstName} ${r.user.lastName}`,acceptedScheduleId:y._id.toString(),acceptedAt:new Date}),await h.atomicDecrementSeats(y._id,A);let k={userId:d.userId,scheduleId:y._id.toString(),seatNumber:y.capacity-(y.availableSeats||0)+1,pickup:d.from,dropoff:d.to,status:"confirmed",price:y.price||0,createdAt:new Date,rideRequestId:t},j=await h.insertBookingDirect(k),W=await a.dismissRideRequestNotifications(t,c);console.log(`[RideRequest] Dismissed ${W} notifications for other drivers`),await a.createNotification({userId:d.userId,type:"ride_request_accepted",title:"Ride Request Accepted!",body:`${r.user.firstName} has reserved a seat for you on their trip from ${d.from} to ${d.to}. They will pick you up soon!`,data:{requestId:t,driverId:c,driverName:`${r.user.firstName} ${r.user.lastName}`,scheduleId:y._id.toString(),bookingId:j._id.toString(),from:d.from,to:d.to}});let Z=(d.notifiedDrivers||[]).filter(Y=>Y!==c);Oe(Z,{type:"RIDE_REQUEST_TAKEN",requestId:t,acceptedBy:`${r.user.firstName} ${r.user.lastName}`,message:"This ride request has been accepted by another driver"}),console.log(`[RideRequest] Request ${t} accepted by driver ${c}`),s.json({success:!0,message:`Seat reserved for ${d.userName}. They have been notified.`,bookingId:j._id.toString(),scheduleId:y._id.toString(),passengerName:d.userName,pickup:d.from,dropoff:d.to,seats:A})}catch(t){console.error("[RideRequest] Accept Error:",t),s.status(500).json({message:t.message})}}),e.post("/api/ride-requests/:id/decline",o,async(r,s)=>{try{if(!r.user)return s.status(401).json({message:"Unauthorized"});if(r.user.role!=="driver")return s.status(403).json({message:"Only drivers can decline ride requests"});let t=r.params.id,c=r.user._id.toString();console.log(`[RideRequest] Driver ${c} declined request ${t}`),s.json({success:!0,message:"Request declined"})}catch(t){console.error("[RideRequest] Decline Error:",t),s.status(500).json({message:t.message})}}),e.post("/api/ride-requests/:id/cancel",o,async(r,s)=>{try{if(!r.user)return s.status(401).json({message:"Unauthorized"});let t=r.params.id,c=r.user._id.toString(),u=await h.findRideRequest(t);if(u&&u.userId!==parseInt(c))return s.status(403).json({message:"Unauthorized"});if(!u)return s.status(404).json({message:"Ride request not found"});u.status==="accepted"&&(u.acceptedScheduleId&&await h.atomicDecrementSeats(u.acceptedScheduleId,-(u.seats||1)),u.acceptedBy&&await a.createNotification({userId:u.acceptedBy,type:"general",title:"Ride Request Cancelled",body:`${r.user.firstName} has cancelled their ride request from ${u.from} to ${u.to}.`,data:{requestId:t,from:u.from,to:u.to}})),await h.updateRideRequest(t,{status:"cancelled",cancelledAt:new Date}),await a.dismissRideRequestNotifications(t),Oe(u.notifiedDrivers||[],{type:"RIDE_REQUEST_CANCELLED",requestId:t,message:"This ride request has been cancelled by the passenger"}),s.json({success:!0,message:"Ride request cancelled"})}catch(t){console.error("[RideRequest] Cancel Error:",t),s.status(500).json({message:t.message})}});let i=(r,s,t)=>{if(!r.user||r.user.role!=="admin")return s.status(403).json({message:"Admin access required"});t()};return e.get("/api/admin/stats",o,i,async(r,s)=>{try{let t=await h.getAdminStats();s.json(t)}catch(t){console.error("[Admin] Stats Error:",t),s.status(500).json({message:t.message})}}),e.get("/api/admin/users",o,i,async(r,s)=>{try{let{role:t,search:c,page:u,limit:d}=r.query,p=await h.getAllUsers({role:t,search:c,page:u?parseInt(u):1,limit:d?parseInt(d):20});s.json(p)}catch(t){console.error("[Admin] Get Users Error:",t),s.status(500).json({message:t.message})}}),e.patch("/api/admin/users/:id/status",o,i,async(r,s)=>{try{let{status:t,reason:c}=r.body;if(!["active","suspended","banned"].includes(t))return s.status(400).json({message:"Invalid status"});let u=await h.updateUserStatus(r.params.id,t,c);if(!u)return s.status(404).json({message:"User not found"});s.json(u)}catch(t){console.error("[Admin] Update User Status Error:",t),s.status(500).json({message:t.message})}}),e.patch("/api/admin/users/:id/role",o,i,async(r,s)=>{try{let{role:t}=r.body;if(!["passenger","driver","admin"].includes(t))return s.status(400).json({message:"Invalid role"});let c=await h.updateUser(r.params.id,{role:t});if(!c)return s.status(404).json({message:"User not found"});s.json(c)}catch(t){console.error("[Admin] Update User Role Error:",t),s.status(500).json({message:t.message})}}),e.delete("/api/admin/users/:id",o,i,async(r,s)=>{try{await h.deleteUser(r.params.id)?s.json({message:"User deleted successfully"}):s.status(404).json({message:"User not found"})}catch(t){console.error("[Admin] Delete User Error:",t),s.status(500).json({message:t.message})}}),e.post("/api/admin/register-staff",o,i,async(r,s)=>{try{let{email:t,password:c,firstName:u,lastName:d,staffType:p}=r.body;if(!t||!c||!u||!d)return s.status(400).json({message:"All fields are required"});if(await h.findUserByEmail(t))return s.status(400).json({message:"Email already registered"});let N=await(await import("bcrypt")).hash(c,10),A=await h.createStaffUser({email:t,password:N,firstName:u,lastName:d,staffType:p});s.status(201).json({message:"Staff member registered successfully",user:A})}catch(t){console.error("[Admin] Register Staff Error:",t),s.status(500).json({message:t.message})}}),e.get("/api/admin/drivers/pending",o,i,async(r,s)=>{try{let t=await h.getPendingKYCDrivers();s.json(t)}catch(t){console.error("[Admin] Pending KYC Error:",t),s.status(500).json({message:t.message})}}),e.post("/api/admin/drivers/:id/approve",o,i,async(r,s)=>{try{let t=r.user._id.toString(),c=await h.approveDriverKYC(r.params.id,t);if(!c)return s.status(404).json({message:"Driver not found"});s.json({message:"Driver approved successfully",driver:c})}catch(t){console.error("[Admin] Approve Driver Error:",t),s.status(500).json({message:t.message})}}),e.post("/api/admin/drivers/:id/reject",o,i,async(r,s)=>{try{let{reason:t}=r.body;if(!t)return s.status(400).json({message:"Rejection reason required"});let c=r.user._id.toString(),u=await h.rejectDriverKYC(r.params.id,c,t);if(!u)return s.status(404).json({message:"Driver not found"});s.json({message:"Driver rejected",driver:u})}catch(t){console.error("[Admin] Reject Driver Error:",t),s.status(500).json({message:t.message})}}),e.get("/api/admin/support-tickets",o,i,async(r,s)=>{try{let{status:t,priority:c}=r.query,u=await h.getAllSupportTickets({status:t,priority:c});s.json(u)}catch(t){console.error("[Admin] Get Tickets Error:",t),s.status(500).json({message:t.message})}}),e.patch("/api/admin/support-tickets/:id",o,i,async(r,s)=>{try{let{status:t,priority:c,adminNotes:u,assignedTo:d}=r.body,p={};t&&(p.status=t),c&&(p.priority=c),u!==void 0&&(p.adminNotes=u),d!==void 0&&(p.assignedTo=d),t==="resolved"&&(p.resolvedAt=new Date);let v=await h.updateSupportTicket(r.params.id,p);if(!v)return s.status(404).json({message:"Ticket not found"});s.json(v)}catch(t){console.error("[Admin] Update Ticket Error:",t),s.status(500).json({message:t.message})}}),e.get("/api/admin/bookings",o,i,async(r,s)=>{try{let{status:t,page:c,limit:u}=r.query,d=await h.getAllBookings({status:t,page:c?parseInt(c):1,limit:u?parseInt(u):20});s.json(d)}catch(t){console.error("[Admin] Get Bookings Error:",t),s.status(500).json({message:t.message})}}),e.delete("/api/admin/bookings/:id",o,i,async(r,s)=>{try{if(!await h.deleteBooking(r.params.id))return s.status(404).json({message:"Booking not found"});s.json({message:"Booking deleted successfully"})}catch(t){console.error("[Admin] Delete Booking Error:",t),s.status(500).json({message:t.message})}}),e.post("/api/support/tickets",o,async(r,s)=>{try{if(!r.user)return s.status(401).json({message:"Unauthorized"});let{subject:t,message:c,category:u,priority:d}=r.body;if(!t||!c)return s.status(400).json({message:"Subject and message are required"});let p=await h.createSupportTicket({odId:r.user._id.toString(),userEmail:r.user.email,userName:`${r.user.firstName} ${r.user.lastName}`,subject:t,message:c,category:u||"other",priority:d||"medium",status:"open"});s.status(201).json(p)}catch(t){console.error("[Support] Create Ticket Error:",t),s.status(500).json({message:t.message})}}),e.get("/api/support/tickets",o,async(r,s)=>{try{if(!r.user)return s.status(401).json({message:"Unauthorized"});let t=await h.getUserSupportTickets(r.user._id.toString());s.json(t)}catch(t){console.error("[Support] Get User Tickets Error:",t),s.status(500).json({message:t.message})}}),e.post("/api/directions",async(r,s)=>{try{let{coordinates:t}=r.body;if(!Array.isArray(t)||t.length<2)return s.status(400).json({message:"At least 2 coordinates required"});let c=await Ie(t);c?s.json(c):s.status(404).json({message:"No route found"})}catch(t){console.error("Directions Error:",t),s.status(500).json({message:t.message})}}),e.all(/^\/api\/.*$/,(r,s)=>{console.warn(`[API 404] Unhandled request: ${r.method} ${r.path}`),console.warn(`[API 404] Full URL: ${r.originalUrl}`),s.status(404).json({message:`API route ${r.method} ${r.path} not found`})}),l}import bs from"express";import Fe from"fs";import Pe from"path";import{fileURLToPath as Ss}from"url";var qr=Pe.dirname(Ss(import.meta.url));function $t(l){let e=Pe.resolve(process.cwd(),"dist");if(!Fe.existsSync(e)){let n=Pe.resolve(process.cwd(),"dist","public");Fe.existsSync(n)&&(e=n)}console.log(`[Static] Serving files from: ${e}`),Fe.existsSync(e)||console.error(`[Static] ERROR: Could not find build directory: ${e}`),l.use(bs.static(e,{index:!1})),l.use((n,o,a)=>{if(n.path.startsWith("/api"))return a();let i=Pe.extname(n.path).toLowerCase();if(i&&[".js",".css",".png",".jpg",".jpeg",".gif",".svg",".ico",".woff",".woff2",".json"].includes(i)&&i!==".html")return console.warn(`[Static] Asset not found (served 404): ${n.path}`),o.status(404).end();let s=Pe.resolve(e,"index.html");Fe.existsSync(s)?o.sendFile(s):o.status(404).send("Front-end build not found. Please run 'npm run build' first.")})}ke();try{Es(["8.8.8.8","8.8.4.4"])}catch(l){console.warn("Failed to set custom DNS servers:",l)}console.log("NODE_ENV:",process.env.NODE_ENV);console.log("PORT:",process.env.PORT);console.log("MAPBOX_ACCESS_TOKEN loaded:",process.env.MAPBOX_ACCESS_TOKEN?"YES":"NO");var X=it(),Me=Rs(X);X.use((l,e,n)=>{l.path.startsWith("/api")&&console.log(`[API REQUEST] ${l.method} ${l.path}`),l.path==="/api/driver/live-status"&&console.log(`[DIAGNOSTIC] Matching live-status route... Headers: ${JSON.stringify(l.headers)}`),n()});X.get("/health",(l,e)=>{e.send("Server is alive")});X.use(it.json({verify:(l,e,n)=>{l.rawBody=n}}));X.use(it.urlencoded({extended:!1}));function M(l,e="express"){let o=`${new Date().toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",second:"2-digit",hour12:!0})} [${e}] ${l}`;console.log(o);try{Mt.appendFileSync(Ft.resolve(process.cwd(),"debug.log"),o+`
`)}catch{}}X.use((l,e,n)=>{let o=Date.now(),a=l.path,i,r=e.json;e.json=function(s,...t){return i=s,r.apply(e,[s,...t])},e.on("finish",()=>{let s=Date.now()-o;if(a.startsWith("/api")){let t=`${l.method} ${a} ${e.statusCode} in ${s}ms`;i&&(t+=` :: ${JSON.stringify(i)}`),M(t)}}),n()});(async()=>{try{await mt()?(console.log("\u2705 MySQL is ready"),await Ct(Me,X),jt(Me)):(console.error("\u26A0\uFE0F MySQL connection failed during startup"),X.all(/^\/api\/.*$/,(r,s)=>{s.status(503).json({message:"Database connection not ready",error:"MySQL connection failed",troubleshooting:["1. Check if DATABASE_URL is set in your .env file","2. Ensure MySQL server is running","3. Verify database credentials","4. Run 'npx drizzle-kit push' to create tables"]})})),X.use((r,s,t,c)=>{let u=r.status||r.statusCode||500,d=r.message||"Internal Server Error";if(console.error("Internal Server Error:",r),t.headersSent)return c(r);t.status(u).json({message:d})});let e=Mt.existsSync(Ft.resolve(process.cwd(),"dist"));if(process.env.NODE_ENV==="production"||e&&process.env.NODE_ENV!=="development")M(e?`Serving static files from dist (NODE_ENV: ${process.env.NODE_ENV})`:"Serving static files (dist not found, but NODE_ENV is production)"),$t(X);else{M("Starting Vite dev server (development mode)");let{setupVite:r}=await Promise.resolve().then(()=>(Ot(),Bt));await r(Me,X)}let o=process.env.PORT||"5000",a=isNaN(Number(o))?o:parseInt(o,10),i=a;if(typeof a=="number"&&process.env.NODE_ENV!=="production")try{let{default:r}=await import("detect-port"),s=await r(a);s!==a&&(console.warn(`\u26A0\uFE0F Port ${a} is in use, using available port ${s}`),i=s)}catch(r){console.warn("Port detection failed, using preferred port:",r)}Me.listen(i,"0.0.0.0",()=>{M(`\u2705 Server running on ${typeof i=="string"?"pipe ":"port "}${i}`)})}catch(l){console.error("\u274C Failed to start server:",l),process.exit(1)}})();export{M as log};
